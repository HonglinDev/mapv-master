(function(M,st){typeof exports=="object"&&typeof module<"u"?st(exports):typeof define=="function"&&define.amd?define(["exports"],st):(M=typeof globalThis<"u"?globalThis:M||self,st(M.mapv={}))})(this,(function(M){"use strict";var st="2.0.62";function G(i){i&&i.clearRect&&i.canvas&&i.clearRect(0,0,i.canvas.width,i.canvas.height)}function we(i){const e=window.devicePixelRatio||1;i.canvas.width=i.canvas.width*e,i.canvas.height=i.canvas.height*e,i.canvas.style.width=i.canvas.width/e+"px",i.canvas.style.height=i.canvas.height/e+"px",i.scale(e,e)}class xt{constructor(){this._subscribers={}}on(e,t){let n=this._subscribers[e];n||(n=[],this._subscribers[e]=n),n.push({callback:t})}off(e,t){const n=this._subscribers[e];if(n)for(let s=0;s<n.length;s++)n[s].callback===t&&(n.splice(s,1),s--)}_trigger(e,t,n){if(e==="*")throw new Error("不能触发事件 *");const s=[];e in this._subscribers&&s.push(...this._subscribers[e]),"*"in this._subscribers&&s.push(...this._subscribers["*"]);for(let a=0,r=s.length;a<r;a++){const o=s[a];o.callback&&o.callback(e,t,n||null)}}static bind(e){const t=new xt;e.on=t.on.bind(t),e.off=t.off.bind(t),e._trigger=t._trigger.bind(t),e._subscribers=t._subscribers}}const K={municipalities:[{n:"北京",g:"116.395645,39.929986|12"},{n:"上海",g:"121.487899,31.249162|12"},{n:"天津",g:"117.210813,39.14393|12"},{n:"重庆",g:"106.530635,29.544606|12"}],provinces:[{n:"安徽",g:"117.216005,31.859252|8",cities:[{n:"合肥",g:"117.282699,31.866942|12"}]},{n:"福建",g:"117.984943,26.050118|8",cities:[{n:"福州",g:"119.330221,26.047125|12"}]},{n:"广东",g:"113.394818,23.408004|8",cities:[{n:"广州",g:"113.30765,23.120049|12"}]},{n:"广西",g:"108.671981,23.745228|8",cities:[{n:"南宁",g:"108.377632,22.81689|12"}]},{n:"贵州",g:"106.713478,26.578343|8",cities:[{n:"贵阳",g:"106.713478,26.578343|12"}]},{n:"海南",g:"110.33119,20.031971|8",cities:[{n:"海口",g:"110.33119,20.031971|12"}]},{n:"河北",g:"114.514862,38.042818|8",cities:[{n:"石家庄",g:"114.514862,38.042818|12"}]},{n:"河南",g:"113.625368,34.746599|8",cities:[{n:"郑州",g:"113.625368,34.746599|12"}]},{n:"黑龙江",g:"126.642464,45.756967|8",cities:[{n:"哈尔滨",g:"126.642464,45.756967|12"}]},{n:"湖北",g:"114.305393,30.59285|8",cities:[{n:"武汉",g:"114.305393,30.59285|12"}]},{n:"湖南",g:"112.93881,28.22808|8",cities:[{n:"长沙",g:"112.93881,28.22808|12"}]},{n:"吉林",g:"125.3245,43.817075|8",cities:[{n:"长春",g:"125.3245,43.817075|12"}]},{n:"江苏",g:"118.796877,32.060255|8",cities:[{n:"南京",g:"118.796877,32.060255|12"}]},{n:"江西",g:"115.858198,28.682025|8",cities:[{n:"南昌",g:"115.858198,28.682025|12"}]},{n:"辽宁",g:"123.43286,41.805698|8",cities:[{n:"沈阳",g:"123.43286,41.805698|12"}]},{n:"内蒙古",g:"111.670801,40.818311|6",cities:[{n:"呼和浩特",g:"111.670801,40.818311|12"}]},{n:"宁夏",g:"106.258357,38.468011|6",cities:[{n:"银川",g:"106.258357,38.468011|12"}]},{n:"青海",g:"101.778245,36.623178|6",cities:[{n:"西宁",g:"101.778245,36.623178|12"}]},{n:"山东",g:"117.000923,36.675807|8",cities:[{n:"济南",g:"117.000923,36.675807|12"}]},{n:"山西",g:"112.54884,37.857014|8",cities:[{n:"太原",g:"112.54884,37.857014|12"}]},{n:"陕西",g:"108.939751,34.341568|8",cities:[{n:"西安",g:"108.939751,34.341568|12"}]},{n:"四川",g:"104.065735,30.570206|8",cities:[{n:"成都",g:"104.065735,30.570206|12"}]},{n:"西藏",g:"91.117514,29.646921|6",cities:[{n:"拉萨",g:"91.117514,29.646921|12"}]},{n:"新疆",g:"87.616842,43.825592|6",cities:[{n:"乌鲁木齐",g:"87.616842,43.825592|12"}]},{n:"云南",g:"102.832891,24.880058|8",cities:[{n:"昆明",g:"102.832891,24.880058|12"}]},{n:"浙江",g:"120.153576,30.287459|8",cities:[{n:"杭州",g:"120.153576,30.287459|12"}]}],other:[{n:"钓鱼岛",g:"123.474498,25.746388|15"},{n:"三沙",g:"112.338941,16.834872|14"}]};function dt(i){const t=i.split("|")[0].split(",");return{lng:parseFloat(t[0]),lat:parseFloat(t[1])}}function _e(i){const e=K.provinces;for(let t=0;t<e.length;t++){const n=e[t].n,s=e[t].cities||[];for(let a=0;a<s.length;a++)if(s[a].n===i)return n}return null}function be(i){i=i.replace("市","");for(let t=0;t<K.municipalities.length;t++)if(K.municipalities[t].n===i)return dt(K.municipalities[t].g);for(let t=0;t<K.other.length;t++)if(K.other[t].n===i)return dt(K.other[t].g);const e=K.provinces;for(let t=0;t<e.length;t++){if(e[t].n===i)return dt(e[t].g);const n=e[t].cities||[];for(let s=0;s<n.length;s++)if(n[s].n===i)return dt(n[s].g)}return null}const Ft={getProvinceNameByCityName:_e,getCenterByCityName:be};let O=class{constructor(e,t){xt.bind(this)(),this._options=t||{},this._data=[],this._dataCache=[],e&&this.add(e)}add(e,t){if(Array.isArray(e)){for(let n=0,s=e.length;n<s;n++)if(e[n]){if(e[n].time&&typeof e[n].time=="string"){const a=e[n].time;a.length===14&&a.substr(0,2)==="20"&&(e[n].time=new Date(a.substr(0,4)+"-"+a.substr(4,2)+"-"+a.substr(6,2)+" "+a.substr(8,2)+":"+a.substr(10,2)+":"+a.substr(12,2)).getTime())}this._data.push(e[n])}}else if(typeof e=="object"&&e!==null)this._data.push(e);else throw new Error("未知的数据类型");this._dataCache=JSON.parse(JSON.stringify(this._data))}reset(){this._data=JSON.parse(JSON.stringify(this._dataCache))}get(e){e=e||{};let t=this._data;if(e.filter){const n=[];for(let s=0;s<t.length;s++)e.filter(t[s])&&n.push(t[s]);t=n}return e.transferCoordinate&&(t=this.transferCoordinate(t,e.transferCoordinate,e.fromColumn,e.toColumn)),t}set(e){this._set(e),this._trigger("change")}_set(e){this.clear(),this.add(e)}clear(e){this._data=[]}update(e,t){const n=this._data;for(let s=0;s<n.length;s++)if(t){let a=!0;for(const r in t)n[s][r]!=t[r]&&(a=!1);a&&e&&e(n[s])}else e&&e(n[s]);this._dataCache=JSON.parse(JSON.stringify(this._data)),this._trigger("change")}transferCoordinate(e,t,n,s){s=s||"_coordinates",n=n||"coordinates";for(let a=0;a<e.length;a++){const r=e[a].geometry;if(!r)continue;const o=r[n];switch(r.type){case"Point":r[s]=t(o);break;case"LineString":const h=[];for(let c=0;c<o.length;c++)h.push(t(o[c]));r[s]=h;break;case"MultiLineString":case"Polygon":const l=this.getPolygon(o,t);r[s]=l;break;case"MultiPolygon":const u=[];for(let c=0;c<o.length;c++){const d=o[c],f=this.getPolygon(d,t);u.push(f)}r[s]=u;break}}return e}getPolygon(e,t){const n=[];for(let s=0;s<e.length;s++){const a=e[s],r=[];for(let o=0;o<a.length;o++)r.push(t(a[o]));n.push(r)}return n}initGeometry(e){e?this._data.forEach(t=>{t.geometry=e(t)}):this._data.forEach(t=>{if(!t.geometry){if(t.lng!==void 0&&t.lat!==void 0)t.geometry={type:"Point",coordinates:[t.lng,t.lat]};else if(t.city){const n=Ft.getCenterByCityName(t.city);n&&(t.geometry={type:"Point",coordinates:[n.lng,n.lat]})}}})}getMax(e){const t=this._data;if(!t||t.length<=0)return;let n=parseFloat(t[0][e]);for(let s=1;s<t.length;s++){const a=parseFloat(t[s][e]);a>n&&(n=a)}return n}getSum(e){const t=this._data;if(!t||t.length<=0)return;let n=0;for(let s=0;s<t.length;s++)t[s][e]&&(n+=parseFloat(t[s][e]));return n}getMin(e){const t=this._data;if(!t||t.length<=0)return;let n=parseFloat(t[0][e]);for(let s=1;s<t.length;s++){const a=parseFloat(t[s][e]);a<n&&(n=a)}return n}getUnique(e){const t=this._data;if(!t||t.length<=0)return;const n={};for(let a=1;a<t.length;a++)n[t[a][e]]=!0;const s=[];for(const a in n)s.push(a);return s}getAverage(e){const t=this._data;if(!t||t.length<=0)return 0;let n=0,s=0;for(let a=0;a<t.length;a++)t[a][e]!==void 0&&(n+=parseFloat(t[a][e]),s++);return s>0?n/s:0}sort(e,t="asc"){this._data.sort((n,s)=>{const a=parseFloat(n[e]),r=parseFloat(s[e]);return t==="desc"?r-a:a-r}),this._trigger("change")}getPage(e,t){const n=(e-1)*t,s=n+t;return this._data.slice(n,s)}getTotal(){return this._data.length}groupBy(e){const t={};return this._data.forEach(n=>{const s=n[e];t[s]||(t[s]=[]),t[s].push(n)}),t}find(e){for(let t=0;t<this._data.length;t++)if(e(this._data[t]))return this._data[t];return null}findAll(e){return this._data.filter(e)}map(e){return this._data.map(e)}filter(e){return this._data.filter(e)}};function xe(i,e,t){const n=60*t+30,s=Math.PI/180*n;return[i.x+e*Math.cos(s),i.y+e*Math.sin(s)]}function Ce(i,e,t,n){for(let s=0;s<6;s++){const a=xe({x:e,y:t},n,s);i.lineTo(a[0],a[1])}}const Q={drawDataSet:function(i,e,t){const n=e instanceof O?e.get():e;for(let s=0,a=n.length;s<a;s++){const r=n[s];this.draw(i,r,t)}},draw:function(i,e,t){if(!e.geometry)return;const n=e.geometry.type,s=e.geometry._coordinates||e.geometry.coordinates,a=e.symbol||t.symbol||"circle";switch(n){case"Point":const r=e._size||e.size||t._size||t.size||5;a==="circle"?(t.bigData==="Point"&&i.moveTo(s[0],s[1]),i.arc(s[0],s[1],r,0,Math.PI*2)):a==="rect"?i.rect(s[0]-r/2,s[1]-r/2,r,r):a==="honeycomb"?Ce(i,s[0],s[1],r):a==="image"&&this.drawImageMarker(i,e,t);break;case"LineString":this.drawLineString(i,s);break;case"MultiLineString":for(let o=0;o<s.length;o++){const h=s[o];this.drawLineString(i,h)}break;case"Polygon":this.drawPolygon(i,s);break;case"MultiPolygon":for(let o=0;o<s.length;o++){const h=s[o];if(this.drawPolygon(i,h),t.multiPolygonDraw){const l=t.multiPolygonDraw();if(l)return l}}break;default:console.error("类型 "+n+" 目前不支持！");break}},drawImageMarker:function(i,e,t){if(!e.geometry)return;const n=e.geometry._coordinates||e.geometry.coordinates,s=n[0],a=n[1],r=Object.assign({},t.image||{},e.image||{}),o=r.url;if(o){const h=new Image;h.onload=function(){const l=e._size||e.size||t._size||t.size||20,u=r.width||l,c=r.height||l;i.drawImage(h,s-u/2,a-c/2,u,c)},h.src=o}else{const h=e._size||e.size||t._size||t.size||5;i.arc(s,a,h,0,Math.PI*2)}},drawLineString:function(i,e){for(let t=0;t<e.length;t++){const n=e[t][0],s=e[t][1];t==0?i.moveTo(n,s):i.lineTo(n,s)}},drawPolygon:function(i,e){i.beginPath();for(let t=0;t<e.length;t++){const n=e[t];i.moveTo(n[0][0],n[0][1]);for(let s=1;s<n.length;s++)i.lineTo(n[s][0],n[s][1]);i.lineTo(n[0][0],n[0][1]),i.closePath()}},drawPolygonEnhanced:function(i,e,t){i.beginPath();for(let n=0;n<e.length;n++){const s=e[n];i.moveTo(s[0][0],s[0][1]);for(let a=1;a<s.length;a++)i.lineTo(s[a][0],s[a][1]);if(i.lineTo(s[0][0],s[0][1]),i.closePath(),t.gradient){const a=i.createLinearGradient(s[0][0],s[0][1],s[2]?s[2][0]:s[0][0],s[2]?s[2][1]:s[0][1]);for(const r in t.gradient)a.addColorStop(parseFloat(r),t.gradient[r]);i.fillStyle=a}}}},Ct={draw:function(i,e,t){const n=e instanceof O?e.get():e;i.save();for(const s in t)i[s]=t[s];if(t.bigData){i.save(),i.beginPath();for(let a=0,r=n.length;a<r;a++){const o=n[a];Q.draw(i,o,t)}const s=t.bigData;if(s=="Point"||s=="Polygon"||s=="MultiPolygon"){i.fill(),i.lineDash&&i.setLineDash(i.lineDash);const a=n[n.length-1];a.lineDash&&i.setLineDash(a.lineDash),(a.strokeStyle||t.strokeStyle)&&t.lineWidth&&i.stroke()}else(s=="LineString"||s=="MultiLineString")&&i.stroke();i.restore()}else for(let s=0,a=n.length;s<a;s++){const r=n[s];if(i.save(),(r.fillStyle||r._fillStyle)&&(i.fillStyle=r.fillStyle||r._fillStyle),(r.strokeStyle||r._strokeStyle)&&(i.strokeStyle=r.strokeStyle||r._strokeStyle),i.lineDash&&i.setLineDash(i.lineDash),r.lineDash&&i.setLineDash(r.lineDash),!r.geometry)continue;const o=r.geometry.type;i.beginPath(),t.multiPolygonDraw=function(){i.fill(),(r.strokeStyle||t.strokeStyle)&&t.lineWidth&&i.stroke()},Q.draw(i,r,t),o=="Point"||o=="Polygon"||o=="MultiPolygon"?(i.fill(),(r.strokeStyle||t.strokeStyle)&&t.lineWidth&&i.stroke()):(o=="LineString"||o=="MultiLineString")&&((r.lineWidth||r._lineWidth)&&(i.lineWidth=r.lineWidth||r._lineWidth),i.stroke()),i.restore()}i.restore()},drawEnhanced:function(i,e,t){let n=e instanceof O?e.get():e;i.save();for(const s in t)["data","filter","transferCoordinate"].includes(s)||(i[s]=t[s]);if(t.filter&&typeof t.filter=="function"&&(n=n.filter(t.filter)),t.bigData){i.save(),i.beginPath();for(let a=0,r=n.length;a<r;a++){const o=n[a];Q.draw(i,o,t)}const s=t.bigData;if(s=="Point"||s=="Polygon"||s=="MultiPolygon"){i.fill(),i.lineDash&&i.setLineDash(i.lineDash);const a=n[n.length-1];a.lineDash&&i.setLineDash(a.lineDash),(a.strokeStyle||t.strokeStyle)&&t.lineWidth&&i.stroke()}else(s=="LineString"||s=="MultiLineString")&&i.stroke();i.restore()}else for(let s=0,a=n.length;s<a;s++){const r=n[s];if(i.save(),(r.fillStyle||r._fillStyle)&&(i.fillStyle=r.fillStyle||r._fillStyle),(r.strokeStyle||r._strokeStyle)&&(i.strokeStyle=r.strokeStyle||r._strokeStyle),(r.lineWidth||r._lineWidth)&&(i.lineWidth=r.lineWidth||r._lineWidth),i.lineDash&&i.setLineDash(i.lineDash),r.lineDash&&i.setLineDash(r.lineDash),(r.shadowBlur||t.shadowBlur)&&(i.shadowBlur=r.shadowBlur||t.shadowBlur||0),(r.shadowColor||t.shadowColor)&&(i.shadowColor=r.shadowColor||t.shadowColor||"rgba(0, 0, 0, 0)"),(r.shadowOffsetX||t.shadowOffsetX)&&(i.shadowOffsetX=r.shadowOffsetX||t.shadowOffsetX||0),(r.shadowOffsetY||t.shadowOffsetY)&&(i.shadowOffsetY=r.shadowOffsetY||t.shadowOffsetY||0),!r.geometry)continue;const o=r.geometry.type;i.beginPath(),t.multiPolygonDraw=function(){i.fill(),(r.strokeStyle||t.strokeStyle)&&t.lineWidth&&i.stroke()},Q.draw(i,r,t),o=="Point"||o=="Polygon"||o=="MultiPolygon"?(i.fill(),(r.strokeStyle||t.strokeStyle)&&t.lineWidth&&i.stroke()):(o=="LineString"||o=="MultiLineString")&&i.stroke(),i.restore()}i.restore()}};function vt(i,e){let t=null;return typeof document<"u"&&(t=document.createElement("canvas"),i!==void 0&&(t.width=i),e!==void 0&&(t.height=e)),t}class tt{constructor(e){this.paletteCtx=null,e=e||{},this.gradient=e.gradient||{.25:"rgba(0, 0, 255, 1)",.55:"rgba(0, 255, 0, 1)",.85:"rgba(255, 255, 0, 1)",1:"rgba(255, 0, 0, 1)"},this.maxSize=e.maxSize||35,this.minSize=e.minSize||0,this.max=e.max||100,this.min=e.min||0,this.initPalette()}setMax(e){this.max=e||100}setMin(e){this.min=e||0}setMaxSize(e){this.maxSize=e||35}setMinSize(e){this.minSize=e||0}initPalette(){const e=this.gradient,t=vt(256,1);if(t&&(this.paletteCtx=t.getContext("2d"),this.paletteCtx)){const n=this.paletteCtx.createLinearGradient(0,0,256,1);for(const s in e)n.addColorStop(parseFloat(s),e[s]);this.paletteCtx.fillStyle=n,this.paletteCtx.fillRect(0,0,256,1)}}getColor(e){const t=this.getImageData(e);return`rgba(${t[0]}, ${t[1]}, ${t[2]}, ${t[3]/256})`}getImageData(e){if(!this.paletteCtx)return[0,0,0,0];const t=this.paletteCtx.getImageData(0,0,256,1).data;if(e===void 0)return t;const n=this.max,s=this.min;let a=e;a>n&&(a=n),a<s&&(a=s);const r=Math.floor((a-s)/(n-s)*255)*4;return[t[r],t[r+1],t[r+2],t[r+3]]}getSize(e){let t=0;const n=this.max,s=this.min,a=this.maxSize,r=this.minSize;let o=e;if(o>n&&(o=n),o<s&&(o=s),n>s)t=r+(o-s)/(n-s)*(a-r);else return a;return t}setGradient(e){this.gradient=e,this.initPalette()}getGradient(){return this.gradient}setTheme(e){const t={rainbow:{0:"blue",.25:"cyan",.5:"lime",.75:"yellow",1:"red"},fire:{0:"black",.25:"purple",.5:"orange",.75:"yellow",1:"white"},water:{0:"white",.25:"lightblue",.5:"blue",.75:"darkblue",1:"black"},earth:{0:"green",.25:"yellowgreen",.5:"yellow",.75:"orange",1:"brown"}};return t[e]?(this.gradient=t[e],this.initPalette(),!0):!1}getThemes(){return["rainbow","fire","water","earth"]}setMinMax(e,t){this.min=e,this.max=t}setMinMaxSize(e,t){this.minSize=e,this.maxSize=t}getLegend(e){const t=this.gradient,n=e.width||20,s=e.height||180,a=vt(n,s);if(!a)return null;const r=a.getContext("2d");if(!r)return null;const o=r.createLinearGradient(0,s,0,0);for(const h in t)o.addColorStop(parseFloat(h),t[h]);if(r.fillStyle=o,r.fillRect(0,0,n,s),e.showLabels!==!1){r.fillStyle="black",r.font="12px Arial",r.textAlign="left";const h=this.max.toString(),l=this.min.toString();r.fillText(h,n+5,12),r.fillText(l,n+5,s);const c=((this.max+this.min)/2).toFixed(1);r.fillText(c,n+5,s/2)}return a}}const Ot=(typeof window>"u"?{}:window).devicePixelRatio||1;function Le(i){const e=i/2,t=i+e,n=1e4,s=vt(t*2,t*2),a=s.getContext("2d");return a&&(a.shadowBlur=e,a.shadowColor="black",a.shadowOffsetX=a.shadowOffsetY=n,a.beginPath(),a.arc(t-n,t-n,i,0,Math.PI*2,!0),a.closePath(),a.fill()),s}function Se(i,e,t){const n=kt(t),s=Ut(t),a=n-s,r=t.range||null;let o=0,h=1024;r&&r.length===2&&(o=(r[0]-s)/a*1024),r&&r.length===2&&(h=(r[1]-s)/a*1024);const l=t.maxOpacity||.8,u=t.minOpacity||0;for(let c=3,d=i.length,f;c<d;c+=4)f=i[c]*4,i[c]/256>l&&(i[c]=256*l),i[c]/256<u&&(i[c]=256*u),f&&f>=o&&f<=h?(i[c-3]=e[f],i[c-2]=e[f+1],i[c-1]=e[f+2]):i[c]=0}function kt(i){return i.max||100}function Ut(i){return i.min||0}function Ee(i,e,t){const n=kt(t),s=Ut(t);let a=t._size;a===void 0&&(a=t.size,a===void 0&&(a=13));const r=new tt({gradient:t.gradient,max:n,min:s}),o=Le(a),h=o.width/2,l=o.height/2,u={};e.forEach(function(c){const d=c.count===void 0?1:c.count,f=Math.min(1,d/n).toFixed(2);u[f]=u[f]||[],u[f].push(c)});for(const c in u){if(isNaN(parseFloat(c)))continue;const d=u[c];i.beginPath(),t.withoutAlpha||(i.globalAlpha=parseFloat(c)),i.strokeStyle=r.getColor(parseFloat(c)*n),d.forEach(function(f){if(!f.geometry)return;const p=f.geometry._coordinates||f.geometry.coordinates,g=f.geometry.type;if(g==="Point"){const y=f.count===void 0?1:f.count;i.globalAlpha=y/n;const w=p;i.drawImage(o,w[0]-h,w[1]-l)}else if(g==="LineString"){const y=f.count===void 0?1:f.count;i.globalAlpha=y/n,i.beginPath(),Q.draw(i,f,t),i.stroke()}})}}function Me(i,e,t){if(i.canvas.width<=0||i.canvas.height<=0)return;const n=t.strength||.3;i.strokeStyle="rgba(0,0,0,"+n+")";let s=vt(i.canvas.width,i.canvas.height);const a=s.getContext("2d");if(!a)return;a.scale(Ot,Ot);const r=e instanceof O?e.get():e;i.save();let o=new tt({gradient:t.gradient});if(Ee(a,r,t),!t.absolute){const h=a.getImageData(0,0,i.canvas.width,i.canvas.height);Se(h.data,o.getImageData(),t),i.putImageData(h,0,0),i.restore()}o=null,s=null}const Zt={draw:Me},Wt={draw:function(i,e,t){i.save();const n=e instanceof O?e.get():e,s={},a=t._size||t.size||50,r="enableCluster"in t?t.enableCluster:!0,o=t.offset||{x:0,y:0},h=new tt({min:t.min||0,max:t.max||100,gradient:t.gradient});if(r){for(let l=0;l<n.length;l++){const u=n[l];if(!u.geometry)continue;const c=u.geometry._coordinates||u.geometry.coordinates,d=Math.floor((c[0]-o.x)/a)+","+Math.floor((c[1]-o.y)/a);s[d]||(s[d]=0),s[d]+=~~(u.count||1)}for(const l in s){const[u,c]=l.split(",").map(Number);i.beginPath(),i.rect(u*a+.5+o.x,c*a+.5+o.y,a,a),i.fillStyle=h.getColor(s[l]),i.fill(),t.strokeStyle&&t.lineWidth&&i.stroke()}}else{for(let l=0;l<n.length;l++){const u=n[l];if(!u.geometry)continue;const d=(u.geometry._coordinates||u.geometry.coordinates).join(",");s[d]=u.count||1}for(const l in s){const[u,c]=l.split(",").map(Number);i.beginPath(),i.rect(u-a/2,c-a/2,a,a),i.fillStyle=h.getColor(s[l]),i.fill(),t.strokeStyle&&t.lineWidth&&i.stroke()}}if(t.label&&t.label.show!==!1){i.fillStyle=t.label.fillStyle||"white",t.label.font&&(i.font=t.label.font),t.label.shadowColor&&(i.shadowColor=t.label.shadowColor),t.label.shadowBlur&&(i.shadowBlur=t.label.shadowBlur);for(const l in s){const[u,c]=l.split(",").map(Number),d=s[l].toString(),f=i.measureText(d).width;r?i.fillText(d,u*a+.5+o.x+a/2-f/2,c*a+.5+o.y+a/2+5):i.fillText(d,u-f/2,c+5)}}i.restore()}};function Pe(i,e,t){const n=60*t+30,s=Math.PI/180*n;return[i.x+e*Math.cos(s),i.y+e*Math.sin(s)]}const Nt={draw:function(i,e,t){i.save();const n=e instanceof O?e.get():e;for(const u in t)i[u]=t[u];const s=t.offset||{x:10,y:10};let a=t._size||t.size||40;a=a/2/Math.sin(Math.PI/3);const r=a*2*Math.sin(Math.PI/3),o=a*1.5,h={};for(let u=0;u<n.length;u++){const c=n[u];if(!c.geometry)continue;const d=c.geometry._coordinates||c.geometry.coordinates,f=(d[1]-s.y)/o;let p=Math.round(f);const g=(d[0]-s.x)/r-(p&1?.5:0);let y=Math.round(g);const w=f-p;if(Math.abs(w)*3>1){const I=g-y,_=y+(g<y?-1:1)/2,b=p+(f<p?-1:1),z=g-_,W=f-b;I*I+w*w>z*z+W*W&&(y=_+(p&1?1:-1)/2,p=b)}const x=y+"-"+p;let S=h[x];S?S.push(c):(S=h[x]=[c],S.i=y,S.j=p,S.x=(y+(p&1?1/2:0))*r,S.y=p*o)}const l=new tt({max:t.max||100,maxSize:a,gradient:t.gradient});for(const u in h){const c=h[u];i.beginPath();for(let f=0;f<6;f++){const p=Pe({x:c.x+s.x,y:c.y+s.y},a,f);i.lineTo(p[0],p[1])}i.closePath();let d=0;for(let f=0;f<c.length;f++)d+=c[f].count||1;c.count=d,i.fillStyle=l.getColor(d),i.fill(),t.strokeStyle&&t.lineWidth&&i.stroke()}if(t.label&&t.label.show!==!1){i.fillStyle=t.label.fillStyle||"white",t.label.font&&(i.font=t.label.font),t.label.shadowColor&&(i.shadowColor=t.label.shadowColor),t.label.shadowBlur&&(i.shadowBlur=t.label.shadowBlur);for(const u in h){const c=h[u];let d=c.count||0;d<0?d=parseFloat(d.toFixed(2)):d=Math.floor(d);const f=i.measureText(d.toString()).width;i.fillText(d.toString(),c.x+s.x-f/2,c.y+s.y+5)}}i.restore()}};function Ht(i,e,t){var n=i.createShader(t);return i.shaderSource(n,e),i.compileShader(n),n}function Lt(i,e,t){var n=Ht(i,e,i.VERTEX_SHADER),s=Ht(i,t,i.FRAGMENT_SHADER),a=i.createProgram();return i.attachShader(a,n),i.attachShader(a,s),i.linkProgram(a),i.useProgram(a),a}function St(i){var e=document.createElement("canvas"),t=e.getContext("2d");return e.width=1,e.height=1,t.fillStyle=i,t.fillRect(0,0,1,1),t.getImageData(0,0,1,1).data}var ze=["attribute vec4 a_Position;","void main() {","gl_Position = a_Position;","gl_PointSize = 30.0;","}"].join(""),Ie=["precision mediump float;","uniform vec4 u_FragColor;","void main() {","gl_FragColor = u_FragColor;","}"].join("");function Te(i,e,t){if(e){var n=Lt(i,ze,Ie);i.enable(i.BLEND),i.blendFunc(i.SRC_ALPHA,i.ONE),i.clear(i.COLOR_BUFFER_BIT);var s=i.canvas.width/2,a=i.canvas.height/2,r=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,r);var o=i.getAttribLocation(n,"a_Position");i.vertexAttribPointer(o,2,i.FLOAT,!1,0,0),i.enableVertexAttribArray(o);var h=i.getUniformLocation(n,"u_FragColor"),l=St(t.strokeStyle||"red");i.uniform4f(h,l[0]/255,l[1]/255,l[2]/255,l[3]/255),i.lineWidth(t.lineWidth||1);for(var u=0,c=e.length;u<c;u++){for(var d=e[u].geometry._coordinates,f=[],p=0;p<d.length;p++){var g=d[p],y=(g[0]-s)/s,w=(a-g[1])/a;f.push(y,w)}var x=new Float32Array(f);i.bufferData(i.ARRAY_BUFFER,x,i.STATIC_DRAW),i.drawArrays(i.LINE_STRIP,0,d.length)}}}const $t={draw:Te};var Re=["attribute vec4 a_Position;","attribute float a_PointSize;","void main() {","gl_Position = a_Position;","gl_PointSize = a_PointSize;","}"].join(""),Ae=["precision mediump float;","uniform vec4 u_FragColor;","void main() {","gl_FragColor = u_FragColor;","}"].join("");function De(i,e,t){if(e){var n=Lt(i,Re,Ae),s=i.getAttribLocation(n,"a_Position"),a=i.getAttribLocation(n,"a_PointSize"),r=i.getUniformLocation(n,"u_FragColor");i.clear(i.COLOR_BUFFER_BIT);for(var o=i.canvas.width/2,h=i.canvas.height/2,l=[],u=0,c=0;c<e.length;c++){var d=e[c].geometry._coordinates,f=(d[0]-o)/o,p=(h-d[1])/h;f<-1||f>1||p<-1||p>1||(l.push(f,p),u++)}var g=new Float32Array(l),y=u,w=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,w),i.bufferData(i.ARRAY_BUFFER,g,i.STATIC_DRAW),i.vertexAttribPointer(s,2,i.FLOAT,!1,0,0),i.enableVertexAttribArray(s),i.vertexAttrib1f(a,t._size);var x=St(t.fillStyle||"red");i.uniform4f(r,x[0]/255,x[1]/255,x[2]/255,x[3]/255),i.drawArrays(i.POINTS,0,y)}}const jt={draw:De};function pt(i,e,t){t=t||2;var n=e&&e.length,s=n?e[0]*t:i.length,a=Vt(i,0,s,t,!0),r=[];if(!a)return r;var o,h,l,u,c,d,f;if(n&&(a=Ue(i,e,a,t)),i.length>80*t){o=l=i[0],h=u=i[1];for(var p=t;p<s;p+=t)c=i[p],d=i[p+1],c<o&&(o=c),d<h&&(h=d),c>l&&(l=c),d>u&&(u=d);f=Math.max(l-o,u-h)}return rt(a,r,t,o,h,f),r}function Vt(i,e,t,n,s){var a,r;if(s===Pt(i,e,t,n)>0)for(a=e;a<t;a+=n)r=Yt(a,i[a],i[a+1],r);else for(a=t-n;a>=e;a-=n)r=Yt(a,i[a],i[a+1],r);return r&&et(r,r.next)&&(lt(r),r=r.next),r}function at(i,e){if(!i)return i;e||(e=i);var t=i,n;do if(n=!1,!t.steiner&&(et(t,t.next)||j(t.prev,t,t.next)===0)){if(lt(t),t=e=t.prev,t===t.next)return null;n=!0}else t=t.next;while(n||t!==e);return e}function rt(i,e,t,n,s,a,r){if(i){!r&&a&&He(i,n,s,a);for(var o=i,h,l;i.prev!==i.next;){if(h=i.prev,l=i.next,a?Fe(i,n,s,a):Be(i)){e.push(h.i/t),e.push(i.i/t),e.push(l.i/t),lt(i),i=l.next,o=l.next;continue}if(i=l,i===o){r?r===1?(i=Oe(i,e,t),rt(i,e,t,n,s,a,2)):r===2&&ke(i,e,t,n,s,a):rt(at(i),e,t,n,s,a,1);break}}}}function Be(i){var e=i.prev,t=i,n=i.next;if(j(e,t,n)>=0)return!1;for(var s=i.next.next;s!==i.prev;){if(gt(e.x,e.y,t.x,t.y,n.x,n.y,s.x,s.y)&&j(s.prev,s,s.next)>=0)return!1;s=s.next}return!0}function Fe(i,e,t,n){var s=i.prev,a=i,r=i.next;if(j(s,a,r)>=0)return!1;for(var o=s.x<a.x?s.x<r.x?s.x:r.x:a.x<r.x?a.x:r.x,h=s.y<a.y?s.y<r.y?s.y:r.y:a.y<r.y?a.y:r.y,l=s.x>a.x?s.x>r.x?s.x:r.x:a.x>r.x?a.x:r.x,u=s.y>a.y?s.y>r.y?s.y:r.y:a.y>r.y?a.y:r.y,c=Et(o,h,e,t,n),d=Et(l,u,e,t,n),f=i.nextZ;f&&f.z<=d;){if(f!==i.prev&&f!==i.next&&gt(s.x,s.y,a.x,a.y,r.x,r.y,f.x,f.y)&&j(f.prev,f,f.next)>=0)return!1;f=f.nextZ}for(f=i.prevZ;f&&f.z>=c;){if(f!==i.prev&&f!==i.next&&gt(s.x,s.y,a.x,a.y,r.x,r.y,f.x,f.y)&&j(f.prev,f,f.next)>=0)return!1;f=f.prevZ}return!0}function Oe(i,e,t){var n=i;do{var s=n.prev,a=n.next.next;!et(s,a)&&Gt(s,n,n.next,a)&&ot(s,a)&&ot(a,s)&&(e.push(s.i/t),e.push(n.i/t),e.push(a.i/t),lt(n),lt(n.next),n=i=a),n=n.next}while(n!==i);return n}function ke(i,e,t,n,s,a){var r=i;do{for(var o=r.next.next;o!==r.prev;){if(r.i!==o.i&&Ve(r,o)){var h=qt(r,o);r=at(r,r.next),h=at(h,h.next),rt(r,e,t,n,s,a),rt(h,e,t,n,s,a);return}o=o.next}r=r.next}while(r!==i)}function Ue(i,e,t,n){var s=[],a,r,o,h,l;for(a=0,r=e.length;a<r;a++)o=e[a]*n,h=a<r-1?e[a+1]*n:i.length,l=Vt(i,o,h,n,!1),l===l.next&&(l.steiner=!0),s.push(je(l));for(s.sort(Ze),a=0;a<s.length;a++)We(s[a],t),t=at(t,t.next);return t}function Ze(i,e){return i.x-e.x}function We(i,e){if(e=Ne(i,e),e){var t=qt(e,i);at(t,t.next)}}function Ne(i,e){var t=e,n=i.x,s=i.y,a=-1/0,r;do{if(s<=t.y&&s>=t.next.y){var o=t.x+(s-t.y)*(t.next.x-t.x)/(t.next.y-t.y);if(o<=n&&o>a){if(a=o,o===n){if(s===t.y)return t;if(s===t.next.y)return t.next}r=t.x<t.next.x?t:t.next}}t=t.next}while(t!==e);if(!r)return null;if(n===a)return r.prev;var h=r,l=r.x,u=r.y,c=1/0,d;for(t=r.next;t!==h;)n>=t.x&&t.x>=l&&gt(s<u?n:a,s,l,u,s<u?a:n,s,t.x,t.y)&&(d=Math.abs(s-t.y)/(n-t.x),(d<c||d===c&&t.x>r.x)&&ot(t,i)&&(r=t,c=d)),t=t.next;return r}function He(i,e,t,n){var s=i;do s.z===null&&(s.z=Et(s.x,s.y,e,t,n)),s.prevZ=s.prev,s.nextZ=s.next,s=s.next;while(s!==i);s.prevZ.nextZ=null,s.prevZ=null,$e(s)}function $e(i){var e,t,n,s,a,r,o,h,l=1;do{for(t=i,i=null,a=null,r=0;t;){for(r++,n=t,o=0,e=0;e<l&&(o++,n=n.nextZ,!!n);e++);for(h=l;o>0||h>0&&n;)o===0?(s=n,n=n.nextZ,h--):h===0||!n||t.z<=n.z?(s=t,t=t.nextZ,o--):(s=n,n=n.nextZ,h--),a?a.nextZ=s:i=s,s.prevZ=a,a=s;t=n}a.nextZ=null,l*=2}while(r>1);return i}function Et(i,e,t,n,s){return i=32767*(i-t)/s,e=32767*(e-n)/s,i=(i|i<<8)&16711935,i=(i|i<<4)&252645135,i=(i|i<<2)&858993459,i=(i|i<<1)&1431655765,e=(e|e<<8)&16711935,e=(e|e<<4)&252645135,e=(e|e<<2)&858993459,e=(e|e<<1)&1431655765,i|e<<1}function je(i){var e=i,t=i;do e.x<t.x&&(t=e),e=e.next;while(e!==i);return t}function gt(i,e,t,n,s,a,r,o){return(s-r)*(e-o)-(i-r)*(a-o)>=0&&(i-r)*(n-o)-(t-r)*(e-o)>=0&&(t-r)*(a-o)-(s-r)*(n-o)>=0}function Ve(i,e){return i.next.i!==e.i&&i.prev.i!==e.i&&!Ge(i,e)&&ot(i,e)&&ot(e,i)&&qe(i,e)}function j(i,e,t){return(e.y-i.y)*(t.x-e.x)-(e.x-i.x)*(t.y-e.y)}function et(i,e){return i.x===e.x&&i.y===e.y}function Gt(i,e,t,n){return et(i,e)&&et(t,n)||et(i,n)&&et(t,e)?!0:j(i,e,t)>0!=j(i,e,n)>0&&j(t,n,i)>0!=j(t,n,e)>0}function Ge(i,e){var t=i;do{if(t.i!==i.i&&t.next.i!==i.i&&t.i!==e.i&&t.next.i!==e.i&&Gt(t,t.next,i,e))return!0;t=t.next}while(t!==i);return!1}function ot(i,e){return j(i.prev,i,i.next)<0?j(i,e,i.next)>=0&&j(i,i.prev,e)>=0:j(i,e,i.prev)<0||j(i,i.next,e)<0}function qe(i,e){var t=i,n=!1,s=(i.x+e.x)/2,a=(i.y+e.y)/2;do t.y>a!=t.next.y>a&&s<(t.next.x-t.x)*(a-t.y)/(t.next.y-t.y)+t.x&&(n=!n),t=t.next;while(t!==i);return n}function qt(i,e){var t=new Mt(i.i,i.x,i.y),n=new Mt(e.i,e.x,e.y),s=i.next,a=e.prev;return i.next=e,e.prev=i,t.next=s,s.prev=t,n.next=t,t.prev=n,a.next=n,n.prev=a,n}function Yt(i,e,t,n){var s=new Mt(i,e,t);return n?(s.next=n.next,s.prev=n,n.next.prev=s,n.next=s):(s.prev=s,s.next=s),s}function lt(i){i.next.prev=i.prev,i.prev.next=i.next,i.prevZ&&(i.prevZ.nextZ=i.nextZ),i.nextZ&&(i.nextZ.prevZ=i.prevZ)}function Mt(i,e,t){this.i=i,this.x=e,this.y=t,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}pt.deviation=function(i,e,t,n){var s=e&&e.length,a=s?e[0]*t:i.length,r=Math.abs(Pt(i,0,a,t));if(s)for(var o=0,h=e.length;o<h;o++){var l=e[o]*t,u=o<h-1?e[o+1]*t:i.length;r-=Math.abs(Pt(i,l,u,t))}var c=0;for(o=0;o<n.length;o+=3){var d=n[o]*t,f=n[o+1]*t,p=n[o+2]*t;c+=Math.abs((i[d]-i[p])*(i[f+1]-i[d+1])-(i[d]-i[f])*(i[p+1]-i[d+1]))}return r===0&&c===0?0:Math.abs((c-r)/r)};function Pt(i,e,t,n){for(var s=0,a=e,r=t-n;a<t;a+=n)s+=(i[r]-i[a])*(i[a+1]+i[r+1]),r=a;return s}pt.flatten=function(i){for(var e=i[0][0].length,t={vertices:[],holes:[],dimensions:e},n=0,s=0;s<i.length;s++){for(var a=0;a<i[s].length;a++)for(var r=0;r<e;r++)t.vertices.push(i[s][a][r]);s>0&&(n+=i[s-1].length,t.holes.push(n))}return t};var Ye=["attribute vec4 a_Position;","void main() {","gl_Position = a_Position;","gl_PointSize = 30.0;","}"].join(""),Xe=["precision mediump float;","uniform vec4 u_FragColor;","void main() {","gl_FragColor = u_FragColor;","}"].join("");function Je(i,e,t){if(e){i.clear(i.COLOR_BUFFER_BIT),i.viewport(0,0,i.canvas.width,i.canvas.height);var n=Lt(i,Ye,Xe);i.enable(i.BLEND),i.blendFunc(i.SRC_ALPHA,i.ONE);var s=i.canvas.width/2,a=i.canvas.height/2;i.bindBuffer(i.ARRAY_BUFFER,i.createBuffer()),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,i.createBuffer());var r=i.getAttribLocation(n,"a_Position");i.vertexAttribPointer(r,2,i.FLOAT,!1,0,0),i.enableVertexAttribArray(r);var o=i.getUniformLocation(n,"u_FragColor"),h=St(t.fillStyle||"red");i.uniform4f(o,h[0]/255,h[1]/255,h[2]/255,h[3]/255),i.lineWidth(t.lineWidth||1);for(var l=[],u=[],c=65536,d=0,f=0,p=e.length;f<p;f++){var g=pt.flatten(e[f].geometry._coordinates||e[f].geometry.coordinates),y=g.vertices;d=l.length/2;for(var w=0;w<y.length;w+=2)y[w]=(y[w]-s)/s,y[w+1]=(a-y[w+1])/a;(l.length+y.length)/2>c&&(i.bufferData(i.ARRAY_BUFFER,new Float32Array(l),i.STATIC_DRAW),i.bufferData(i.ELEMENT_ARRAY_BUFFER,new Uint16Array(u),i.STATIC_DRAW),i.drawElements(i.TRIANGLES,u.length,i.UNSIGNED_SHORT,0),l.length=0,u.length=0,d=0);for(var w=0;w<y.length;w++)l.push(y[w]);for(var x=pt(y,g.holes,g.dimensions),w=0;w<x.length;w++)u.push(x[w]+d)}i.bufferData(i.ARRAY_BUFFER,new Float32Array(l),i.STATIC_DRAW),i.bufferData(i.ELEMENT_ARRAY_BUFFER,new Uint16Array(u),i.STATIC_DRAW),i.drawElements(i.TRIANGLES,u.length,i.UNSIGNED_SHORT,0),i.bindBuffer(i.ARRAY_BUFFER,null),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null)}}const Xt={draw:Je},Jt={draw:function(i,e,t){var n=e instanceof O?e.get():e;n.length>0&&(n[0].geometry.type=="LineString"?$t.draw(i,n,t):n[0].geometry.type=="Polygon"||n[0].geometry.type=="MultiPolygon"?Xt.draw(i,n,t):jt.draw(i,n,t))}};function Ke(i,e,t){if(!i||!e)return null;const n=_=>1-2*_+_*_,s=_=>2*_-2*_*_,a=_=>_*_,r=[],o=t||40;let h=0;const l=parseFloat(i.lat.toString()),u=parseFloat(e.lat.toString()),c=parseFloat(i.lng.toString()),d=parseFloat(e.lng.toString());let f=c,p=d;p>f&&parseFloat((p-f).toString())>180&&f<0&&(f=parseFloat((360+f).toString()),p=parseFloat((360+p).toString()));let g,y,w,x,S;u===l?(g=0,y=f-p):p===f?(g=Math.PI/2,y=l-u):(g=Math.atan((u-l)/(p-f)),y=(u-l)/Math.sin(g));const I=g+Math.PI/5;w=y/2,S=w*Math.cos(I)+f,x=w*Math.sin(I)+l;for(let _=0;_<o+1;_++){const b=f*n(h)+S*s(h)+p*a(h),z=l*n(h)+x*s(h)+u*a(h),W=i.lng,E=e.lng;r.push([W<0&&E>0?b-360:b,z]),h+=1/o}return r}function Qe(i,e){let t=[];for(let n=0;n<i.length-1;n++){const s=Ke(i[n],i[n+1],e?.count);s&&s.length>0&&(t=t.concat(s))}return t}const ti={getPoints:Qe};var ei=function(){var i={},e=[],t=[],n=[],s=.1,a=.1,r=1,o=2,h=6,l=70,u=.6666667,c=.6,d=1e-8;function f(v,m){return v.x*m.x+v.y*m.y}function p(v){return{x:i[v.target].x-i[v.source].x,y:i[v.target].y-i[v.source].y}}function g(v){return Math.sqrt(Math.pow(i[v.source].x-i[v.target].x,2)+Math.pow(i[v.source].y-i[v.target].y,2))}function y(v){return Math.sqrt(Math.pow(v.source.x-v.target.x,2)+Math.pow(v.source.y-v.target.y,2))}function w(v){var m=(i[v.source].x+i[v.target].x)/2,C=(i[v.source].y+i[v.target].y)/2;return{x:m,y:C}}function x(v){for(var m=0,C=1;C<n[v].length;C++){var D=S(n[v][C],n[v][C-1]);m+=D}return m}function S(v,m){return Math.sqrt(Math.pow(v.x-m.x,2)+Math.pow(v.y-m.y,2))}function I(v,m){var C=Math.sqrt((m.target.x-m.source.x)*(m.target.x-m.source.x)+(m.target.y-m.source.y)*(m.target.y-m.source.y)),D=((m.source.y-v.y)*(m.source.y-m.target.y)-(m.source.x-v.x)*(m.target.x-m.source.x))/(C*C);return{x:m.source.x+D*(m.target.x-m.source.x),y:m.source.y+D*(m.target.y-m.source.y)}}function _(){for(var v=0;v<e.length;v++)n[v]=[]}function b(){for(var v=0;v<e.length;v++)t[v]=[]}function z(v){for(var m=[],C=0;C<v.length;C++)i[v[C].source].x!=i[v[C].target].x&&i[v[C].source].y!=i[v[C].target].y&&m.push(v[C]);return m}function W(v,m,C){var D=n[v][m-1],k=n[v][m+1],A=n[v][m],T=D.x-A.x+k.x-A.x,N=D.y-A.y+k.y-A.y;return T*=C,N*=C,{x:T,y:N}}function E(v,m,C){for(var D={x:0,y:0},k=t[v],A=0;A<k.length;A++){var T={x:n[k[A]][m].x-n[v][m].x,y:n[k[A]][m].y-n[v][m].y};if(Math.abs(T.x)>d||Math.abs(T.y)>d){var N=1/Math.pow(y({source:n[k[A]][m],target:n[v][m]}),1);D.x+=T.x*N,D.y+=T.y*N}}return D}function R(v,m,C){for(var D=s/(g(e[v])*(m+1)),k=[{x:0,y:0}],A=1;A<m+1;A++){var T={x:0,y:0},N=W(v,A,D),X=E(v,A);T.x=C*(N.x+X.x),T.y=C*(N.y+X.y),k.push(T)}return k.push({x:0,y:0}),k}function F(v){for(var m=0;m<e.length;m++)if(v==1)n[m].push(i[e[m].source]),n[m].push(w(e[m])),n[m].push(i[e[m].target]);else{var C=x(m),D=C/(v+1),k=D,A=[];A.push(i[e[m].source]);for(var T=1;T<n[m].length;T++){for(var N=S(n[m][T],n[m][T-1]);N>k;){var X=k/N,me=n[m][T-1].x,ye=n[m][T-1].y;me+=X*(n[m][T].x-n[m][T-1].x),ye+=X*(n[m][T].y-n[m][T-1].y),A.push({x:me,y:ye}),N-=k,k=D}k-=N}A.push(i[e[m].target]),n[m]=A}}function wt(v,m){var C=Math.abs(f(p(v),p(m))/(g(v)*g(m)));return C}function ct(v,m){var C=(g(v)+g(m))/2,D=2/(C/Math.min(g(v),g(m))+Math.max(g(v),g(m))/C);return D}function _t(v,m){var C=(g(v)+g(m))/2,D={x:(i[v.source].x+i[v.target].x)/2,y:(i[v.source].y+i[v.target].y)/2},k={x:(i[m.source].x+i[m.target].x)/2,y:(i[m.source].y+i[m.target].y)/2},A=C/(C+S(D,k));return A}function bt(v,m){var C=I(i[m.source],{source:i[v.source],target:i[v.target]}),D=I(i[m.target],{source:i[v.source],target:i[v.target]}),k={x:(C.x+D.x)/2,y:(C.y+D.y)/2},A={x:(i[v.source].x+i[v.target].x)/2,y:(i[v.source].y+i[v.target].y)/2},T=Math.max(0,1-2*S(A,k)/S(C,D));return T}function ft(v,m){return Math.min(bt(v,m),bt(m,v))}function Oi(v,m){var C=wt(v,m)*ct(v,m)*_t(v,m)*ft(v,m);return C}function ki(v,m){return Oi(v,m)>=c}function Ui(){for(var v=0;v<e.length-1;v++)for(var m=v+1;m<e.length;m++)v!=m&&ki(e[v],e[m])&&(t[v].push(m),t[m].push(v))}var Z=function(){var v=a,m=l,C=r;_(),b(),F(C),Ui();for(var D=0;D<h;D++){for(var k=0;k<m;k++){for(var A=[],T=0;T<e.length;T++)A[T]=R(T,C,v);for(var N=0;N<e.length;N++)for(var X=0;X<C+1;X++)n[N][X].x+=A[N][X].x,n[N][X].y+=A[N][X].y}v=v/2,C=C*2,m=u*m,F(C)}return n};return Z.nodes=function(v){return arguments.length==0?i:(i=v,Z)},Z.edges=function(v){return arguments.length==0?e:(e=z(v),Z)},Z.bundling_stiffness=function(v){return arguments.length==0?s:(s=v,Z)},Z.step_size=function(v){return arguments.length==0?a:(a=v,Z)},Z.cycles=function(v){return arguments.length==0?h:(h=v,Z)},Z.iterations=function(v){return arguments.length==0?l:(l=v,Z)},Z.iterations_rate=function(v){return arguments.length==0?u:(u=v,Z)},Z.subdivision_points_seed=function(v){return arguments.length==0?P:(P=v,Z)},Z.subdivision_rate=function(v){return arguments.length==0?o:(o=v,Z)},Z.compatbility_threshold=function(v){return arguments.length==0?compatbility_threshold:(c=v,Z)},Z};class Kt{constructor(e={other:1}){this.splitList=e}get(e){const t=this.splitList;let n=t.other;for(const s in t)if(e==s){n=t[s];break}return n}generateByDataSet(e,t){const n=t||["rgba(255, 255, 0, 0.8)","rgba(253, 98, 104, 0.8)","rgba(255, 146, 149, 0.8)","rgba(255, 241, 193, 0.8)","rgba(110, 176, 253, 0.8)","rgba(52, 139, 251, 0.8)","rgba(17, 102, 252, 0.8)"],s=e.get();this.splitList={};let a=0;for(let r=0;r<s.length;r++){const o=s[r].count;if(this.splitList[o]===void 0&&(this.splitList[o]=n[a],a++),a>=n.length-1)break}this.splitList.other=n[n.length-1]}generateByUniqueValues(e,t,n){const s=e.getUnique(t),a=n||this.getDefaultColors();this.splitList={};for(let r=0;r<s.length;r++)this.splitList[s[r]]=a[r%a.length];this.splitList.other=a[a.length-1]}getDefaultColors(){return["rgba(255, 255, 0, 0.8)","rgba(253, 98, 104, 0.8)","rgba(255, 146, 149, 0.8)","rgba(255, 241, 193, 0.8)","rgba(110, 176, 253, 0.8)","rgba(52, 139, 251, 0.8)","rgba(17, 102, 252, 0.8)","rgba(0, 176, 104, 0.8)","rgba(128, 128, 128, 0.8)","rgba(255, 0, 255, 0.8)"]}addCategory(e,t){this.splitList[e]=t}removeCategory(e){delete this.splitList[e]}updateCategory(e,t){return this.splitList[e]!==void 0?(this.splitList[e]=t,!0):!1}getCategories(){return this.splitList}getLegend(e){const t=this.splitList,n=document.createElement("div");n.style.cssText="background:#fff; padding: 5px; border: 1px solid #ccc;";let s="";for(const a in t)s+=`<div style="line-height: 19px;" value="${a}"><span style="vertical-align: -2px; display: inline-block; width: 30px;height: 19px;background:${t[a]};"></span><span style="margin-left: 3px;">${a}<span></div>`;return n.innerHTML=s,n}}class Qt{constructor(e=[{start:0,value:"red"}]){this.splitList=e}get(e){const t=this.splitList;let n=!1;for(let s=0;s<t.length;s++){const a=t[s],r=a.start===void 0||e>=a.start,o=a.end===void 0||e<a.end;if(r&&o){n=a.value;break}}return n}generateByDataSet(e){const t=e.getMin("count")||0,n=e.getMax("count")||100;this.generateByMinMax(t,n)}generateByMinMax(e,t){const n=["rgba(255, 255, 0, 0.8)","rgba(253, 98, 104, 0.8)","rgba(255, 146, 149, 0.8)","rgba(255, 241, 193, 0.8)","rgba(110, 176, 253, 0.8)","rgba(52, 139, 251, 0.8)","rgba(17, 102, 252, 0.8)"],s=Number((t-e)/7),a=Number(t);let r=Number(e);this.splitList=[];let o=0;for(;r<a;)this.splitList.push({start:r,end:r+s,value:n[o]}),o++,r+=s}generateByCustomRange(e,t){const n=t||this.getDefaultColors();this.splitList=[];for(let s=0;s<e.length;s++)this.splitList.push({start:e[s].start,end:e[s].end,value:n[s%n.length]})}getDefaultColors(){return["rgba(255, 255, 0, 0.8)","rgba(253, 98, 104, 0.8)","rgba(255, 146, 149, 0.8)","rgba(255, 241, 193, 0.8)","rgba(110, 176, 253, 0.8)","rgba(52, 139, 251, 0.8)","rgba(17, 102, 252, 0.8)","rgba(0, 176, 104, 0.8)","rgba(128, 128, 128, 0.8)","rgba(255, 0, 255, 0.8)"]}addRange(e){this.splitList.push(e),this.splitList.sort((t,n)=>(t.start||0)-(n.start||0))}removeRange(e){e>=0&&e<this.splitList.length&&this.splitList.splice(e,1)}updateRange(e,t){return e>=0&&e<this.splitList.length?(this.splitList[e]=t,this.splitList.sort((n,s)=>(n.start||0)-(s.start||0)),!0):!1}getRanges(){return this.splitList}getLegend(e){const t=this.splitList,n=document.createElement("div");n.style.cssText="background:#fff; padding: 5px; border: 1px solid #ccc;";let s="";for(let a=0;a<t.length;a++){const r=t[a];let o="";r.start!==void 0&&r.end!==void 0?o=`${r.start} - ${r.end}`:r.start!==void 0?o=`> ${r.start}`:r.end!==void 0?o=`< ${r.end}`:o="All",s+=`<div style="line-height: 19px;"><span style="vertical-align: -2px; display: inline-block; width: 30px;height: 19px;background:${r.value};"></span><span style="margin-left: 3px;">${o}<span></div>`}return n.innerHTML=s,n}}class ii{constructor(e,t,n){if(!e||!t)return console.warn("id 和 type 为必填项"),!1;if(t=="baidu"){if(!BMap)return console.warn("请先引入百度地图JS API"),!1}else console.warn("暂不支持你的地图类型");this.type=t;var s=n&&n.center?n.center:[106.962497,38.208726],a=n&&n.zoom?n.zoom:5,r=this.map=new BMap.Map(e,{enableMapClick:!1});r.centerAndZoom(new BMap.Point(s[0],s[1]),a),r.enableScrollWheelZoom(!0),r.setMapStyle({style:"light"})}addLayer(e,t){if(this.type=="baidu")return new mapv.baiduMapLayer(this.map,dataSet,t)}getMap(){return this.map}}function Y(i){this.options=i||{},this.paneName=this.options.paneName||"mapPane",this.context=this.options.context||"2d",this.zIndex=this.options.zIndex||0,this.mixBlendMode=this.options.mixBlendMode||null,this.enableMassClear=this.options.enableMassClear,this._map=i.map,this._lastDrawTime=null,this.show()}var zt=typeof window>"u"?{}:window,te=zt.BMap||zt.BMapGL;te&&(Y.prototype=new te.Overlay,Y.prototype.initialize=function(i){this._map=i;var e=this.canvas=document.createElement("canvas");e.style.cssText="position:absolute;left:0;top:0;z-index:"+this.zIndex+";user-select:none;",e.style.mixBlendMode=this.mixBlendMode,this.adjustSize();var t=i.getPanes()[this.paneName];t||(t=i.getPanes().floatShadow),t.appendChild(e);var n=this;return i.addEventListener("resize",function(){n.adjustSize(),n._draw()}),i.addEventListener("update",function(){n._draw()}),this.options.updateImmediate&&setTimeout(function(){n._draw()},100),this.canvas},Y.prototype.adjustSize=function(){var i=this._map.getSize(),e=this.canvas,t=this.devicePixelRatio=zt.devicePixelRatio||1;e.width=i.width*t,e.height=i.height*t,this.context=="2d"&&e.getContext(this.context).scale(t,t),e.style.width=i.width+"px",e.style.height=i.height+"px"},Y.prototype.draw=function(){var i=this;this.options.updateImmediate?i._draw():(clearTimeout(i.timeoutID),i.timeoutID=setTimeout(function(){i._draw()},15))},Y.prototype._draw=function(){var i=this._map,e=i.getSize(),t=i.getCenter();if(t){var n=i.pointToOverlayPixel(t);this.canvas.style.left=n.x-e.width/2+"px",this.canvas.style.top=n.y-e.height/2+"px",this.dispatchEvent("draw"),this.options.update&&this.options.update.call(this)}},Y.prototype.getContainer=function(){return this.canvas},Y.prototype.show=function(){this.canvas||this._map.addOverlay(this),this.canvas.style.display="block"},Y.prototype.hide=function(){this.canvas.style.display="none"},Y.prototype.setZIndex=function(i){this.zIndex=i,this.canvas.style.zIndex=this.zIndex},Y.prototype.getZIndex=function(){return this.zIndex});const U=(function(){const i=[];return{getAll:function(){return i},removeAll:function(){i.length=0},add:function(e){i.push(e)},remove:function(e){const t=i.indexOf(e);t!==-1&&i.splice(t,1)},update:function(e,t){if(i.length===0)return!1;let n=0;for(e=e!==void 0?e:U.now();n<i.length;)i[n].update(e)||t?n++:i.splice(n,1);return!0},now:function(){return 0}}})();typeof window>"u"&&typeof process<"u"?U.now=function(){const i=process.hrtime();return i[0]*1e3+i[1]/1e6}:typeof window<"u"&&window.performance!==void 0&&window.performance.now!==void 0?U.now=window.performance.now.bind(window.performance):Date.now!==void 0?U.now=Date.now:U.now=function(){return new Date().getTime()},U.Tween=function(i){const e=i,t={};let n={},s={},a=1e3,r=0,o,h=!1,l=!1,u=0,c=null,d=U.Easing.Linear.None,f=U.Interpolation.Linear;const p=[];let g=null,y=!1,w=null,x=null,S=null;return{to:function(_,b){return n=_,b!==void 0&&(a=b),this},start:function(_){U.add(this),l=!0,y=!1,c=_!==void 0?_:U.now(),c+=u;for(const b in n){if(n[b]instanceof Array){if(n[b].length===0)continue;n[b]=[e[b]].concat(n[b])}e[b]!==void 0&&(t[b]=e[b],t[b]instanceof Array||(t[b]=Number(t[b])),s[b]=t[b]||0)}return this},stop:function(){return l?(U.remove(this),l=!1,S!==null&&S.call(e,e),this.stopChainedTweens(),this):this},end:function(){return this.update(c+a),this},stopChainedTweens:function(){for(let _=0,b=p.length;_<b;_++)p[_].stop();return this},delay:function(_){return u=_,this},repeat:function(_){return r=_,this},repeatDelay:function(_){return o=_,this},yoyo:function(_){return h=_,this},easing:function(_){return d=_,this},interpolation:function(_){return f=_,this},chain:function(..._){p.length=0;for(let b=0,z=_.length;b<z;b++)p.push(_[b]);return this},onStart:function(_){return g=_,this},onUpdate:function(_){return w=_,this},onComplete:function(_){return x=_,this},onStop:function(_){return S=_,this},update:function(_){let b,z,W;if(_<c)return!0;y===!1&&(g!==null&&g.call(e,e),y=!0),z=(_-c)/a,z=z>1?1:z,W=d(z);for(b in n){if(t[b]===void 0)continue;const E=t[b],R=n[b];if(R instanceof Array)e[b]=f(R,W);else{let F;typeof R=="string"?R.charAt(0)==="+"||R.charAt(0)==="-"?F=E+parseFloat(R):F=parseFloat(R):F=R,typeof F=="number"&&(e[b]=E+(F-E)*W)}}if(w!==null&&w.call(e,W),z===1)if(r>0){isFinite(r)&&r--;for(b in s){const E=n[b];if(typeof E=="string"?s[b]+=parseFloat(E):typeof E=="number"&&(s[b]+=E),h){const R=s[b],F=n[b];typeof F=="number"&&(s[b]=F,n[b]=R)}t[b]=s[b]}return o!==void 0?c=_+o:c=_+u,!0}else{x!==null&&x.call(e,e);for(let E=0,R=p.length;E<R;E++)p[E].start(c+a);return!1}return!0}}},U.Easing={Linear:{None:function(i){return i}},Quadratic:{In:function(i){return i*i},Out:function(i){return i*(2-i)},InOut:function(i){return(i*=2)<1?.5*i*i:-.5*(--i*(i-2)-1)}},Cubic:{In:function(i){return i*i*i},Out:function(i){return--i*i*i+1},InOut:function(i){return(i*=2)<1?.5*i*i*i:.5*((i-=2)*i*i+2)}},Quartic:{In:function(i){return i*i*i*i},Out:function(i){return 1- --i*i*i*i},InOut:function(i){return(i*=2)<1?.5*i*i*i*i:-.5*((i-=2)*i*i*i-2)}},Quintic:{In:function(i){return i*i*i*i*i},Out:function(i){return--i*i*i*i*i+1},InOut:function(i){return(i*=2)<1?.5*i*i*i*i*i:.5*((i-=2)*i*i*i*i+2)}},Sinusoidal:{In:function(i){return 1-Math.cos(i*Math.PI/2)},Out:function(i){return Math.sin(i*Math.PI/2)},InOut:function(i){return .5*(1-Math.cos(Math.PI*i))}},Exponential:{In:function(i){return i===0?0:Math.pow(1024,i-1)},Out:function(i){return i===1?1:1-Math.pow(2,-10*i)},InOut:function(i){return i===0?0:i===1?1:(i*=2)<1?.5*Math.pow(1024,i-1):.5*(-Math.pow(2,-10*(i-1))+2)}},Circular:{In:function(i){return 1-Math.sqrt(1-i*i)},Out:function(i){return Math.sqrt(1- --i*i)},InOut:function(i){return(i*=2)<1?-.5*(Math.sqrt(1-i*i)-1):.5*(Math.sqrt(1-(i-=2)*i)+1)}},Elastic:{In:function(i){return i===0?0:i===1?1:-Math.pow(2,10*(i-1))*Math.sin((i-1.1)*5*Math.PI)},Out:function(i){return i===0?0:i===1?1:Math.pow(2,-10*i)*Math.sin((i-.1)*5*Math.PI)+1},InOut:function(i){return i===0?0:i===1?1:(i*=2,i<1?-.5*Math.pow(2,10*(i-1))*Math.sin((i-1.1)*5*Math.PI):.5*Math.pow(2,-10*(i-1))*Math.sin((i-1.1)*5*Math.PI)+1)}},Back:{In:function(i){return i*i*((1.70158+1)*i-1.70158)},Out:function(i){return--i*i*((1.70158+1)*i+1.70158)+1},InOut:function(i){const e=2.5949095;return(i*=2)<1?.5*(i*i*((e+1)*i-e)):.5*((i-=2)*i*((e+1)*i+e)+2)}},Bounce:{In:function(i){return 1-U.Easing.Bounce.Out(1-i)},Out:function(i){return i<1/2.75?7.5625*i*i:i<2/2.75?7.5625*(i-=1.5/2.75)*i+.75:i<2.5/2.75?7.5625*(i-=2.25/2.75)*i+.9375:7.5625*(i-=2.625/2.75)*i+.984375},InOut:function(i){return i<.5?U.Easing.Bounce.In(i*2)*.5:U.Easing.Bounce.Out(i*2-1)*.5+.5}}},U.Interpolation={Linear:function(i,e){const t=i.length-1,n=t*e,s=Math.floor(n),a=U.Interpolation.Utils.Linear;return e<0?a(i[0],i[1],n):e>1?a(i[t],i[t-1],t-n):a(i[s],i[s+1>t?t:s+1],n-s)},Bezier:function(i,e){let t=0;const n=i.length-1,s=Math.pow,a=U.Interpolation.Utils.Bernstein;for(let r=0;r<=n;r++)t+=s(1-e,n-r)*s(e,r)*i[r]*a(n,r);return t},CatmullRom:function(i,e){const t=i.length-1;let n=t*e,s=Math.floor(n);const a=U.Interpolation.Utils.CatmullRom;return i[0]===i[t]?(e<0&&(s=Math.floor(n=t*(1+e))),a(i[(s-1+t)%t],i[s],i[(s+1)%t],i[(s+2)%t],n-s)):e<0?i[0]-(a(i[0],i[0],i[1],i[1],-n)-i[0]):e>1?i[t]-(a(i[t],i[t],i[t-1],i[t-1],n-t)-i[t]):a(i[s?s-1:0],i[s],i[t<s+1?t:s+1],i[t<s+2?t:s+2],n-s)},Utils:{Linear:function(i,e,t){return(e-i)*t+i},Bernstein:function(i,e){const t=U.Interpolation.Utils.Factorial;return t(i)/t(e)/t(i-e)},Factorial:(function(){const i=[1];return function(e){let t=1;if(i[e])return i[e];for(let n=e;n>1;n--)t*=n;return i[e]=t,t}})(),CatmullRom:function(i,e,t,n,s){const a=(t-i)*.5,r=(n-e)*.5,o=s*s,h=s*o;return(2*e-2*t+a+r)*h+(-3*e+3*t-2*a-r)*o+a*s+e}}};function ni(i,e){const t=e[0]-i[0],n=e[1]-i[1];let s=360*Math.atan(n/t)/(2*Math.PI);return e[0]<i[0]&&(s=s+180),s}const mt={},ee={draw:function(i,e,t){let n="http://huiyan.baidu.com/github/tools/gis-drawing/static/images/direction.png";t.arrow&&t.arrow.url&&(n=t.arrow.url),mt[n]||(mt[n]=null);let s=mt[n];if(!s){const o=Array.prototype.slice.call(arguments),h=new Image;h.onload=()=>{mt[n]=h,ee.draw.apply(null,o)},h.src=n;return}const a=e instanceof O?e.get():e;i.save();for(const o in t)i[o]=t[o];let r=null;for(let o=0,h=a.length;o<h;o++){const l=a[o];if(i.save(),(l.fillStyle||l._fillStyle)&&(i.fillStyle=l.fillStyle||l._fillStyle),(l.strokeStyle||l._strokeStyle)&&(i.strokeStyle=l.strokeStyle||l._strokeStyle),!l.geometry){i.restore();continue}const u=l.geometry.type;if(i.beginPath(),u==="LineString"){const c=l.geometry._coordinates||l.geometry.coordinates,d=t.arrow.interval!==void 0?t.arrow.interval:1;for(let f=0;f<c.length;f+=d)if(c[f]&&c[f+1]){const p=c[f];if(r&&si(p,r)<30)continue;i.save();const g=ni(c[f],c[f+1]);i.translate(p[0],p[1]),i.rotate(g*Math.PI/180),i.drawImage(s,-s.width/4,-s.height/4,s.width/2,s.height/2),i.restore(),r=p}}i.restore()}i.restore()}};function si(i,e){return Math.sqrt(Math.pow(i[0]-e[0],2)+Math.pow(i[1]-e[1],2))}const ai={draw:function(i,e,t){const n=e instanceof O?e.get():e;i.save(),i.fillStyle=t.fillStyle||"rgba(0, 0, 0, 0.5)",i.fillRect(0,0,i.canvas.width,i.canvas.height),t.multiPolygonDraw=function(){i.save(),i.clip(),G(i),i.restore()};for(let s=0,a=n.length;s<a;s++)i.beginPath(),Q.drawDataSet(i,[n[s]],t),i.save(),i.clip(),G(i),i.restore();i.restore()}},it={};let H={};const ri={draw:function(i,e,t){i.save();const n=e instanceof O?e.get():e;for(let s=0;s<n.length;s++){let a=n[s];i.beginPath(),a.properties&&a.properties.cluster?this.drawClusterPoint(a,t,i):this.drawIcon(a,t,i)}i.restore()},drawClusterPoint:function(i,e,t){if(e.label&&e.label.iconOptions&&e.show!==!1&&e.label.iconOptions.show)this.drawSeanIcon(i,e.label,t);else{let n=i.geometry._coordinates||i.geometry.coordinates,s=n[0],a=n[1],r=Object.assign({},e.label||{});if(t.beginPath(),t.arc(s,a,i.size,0,Math.PI*2),t.fillStyle=i.fillStyle||"rgba(200, 0, 0, 0.8)",t.fill(),t.strokeStyle="rgba(255, 255, 255, 1)",t.lineWidth=1,t.stroke(),r.show!==!1){t.fillStyle=r.fillStyle||"white",t.textAlign="center",t.textBaseline="middle",r.font?t.font=r.font:t.font="bold 14px Arial",r.shadowColor&&(t.shadowColor=r.shadowColor),r.shadowBlur&&(t.shadowBlur=r.shadowBlur);let o=i.properties.point_count.toString(),h=t.measureText(o).width;t.fillText(o,s+.5-h/2,a+.5+3)}}},drawIcon:function(e,t,n){const s=e.geometry._coordinates||e.geometry.coordinates;let a=s[0],r=s[1];const o=Object.assign({},t.iconOptions,e.iconOptions),h=function(){n.beginPath(),n.arc(s[0],s[1],t.size||5,0,Math.PI*2),n.fillStyle=t.fillStyle||"red",n.fill()};if(!o.url){h();return}let l=o.width,u=o.height;const c=o.offset||{x:0,y:0};a=a-~~l/2+c.x,r=r-~~u/2+c.y;const d=window.encodeURIComponent(o.url),f=it[d];f?(f==="error"?h():l&&u?n.drawImage(f,a,r,l,u):n.drawImage(f,a,r),o.label&&o.label.show!==!1&&ie(n,a+~~l/2,r+~~u/2,l,u,o.label)):(H[d]||(H[d]=[],ne(d,function(p,g){H[g]&&H[g].forEach(function(y){return y(p)}),H[g]=[],it[g]=p},function(p){H[p]&&H[p].forEach(function(g){return g("error")}),H[p]=[],it[p]="error",h()})),H[d].push((function(p,g,y,w){return function(x){x==="error"?h():y&&w?n.drawImage(x,p,g,y,w):n.drawImage(x,p,g),o.label&&o.label.show!==!1&&ie(n,p+~~y/2,g+~~w/2,y,w,o.label)}})(a,r,l,u)))},drawSeanIcon:function(e,t,n){const s=e.geometry._coordinates||e.geometry.coordinates;let a=s[0],r=s[1];const o=Object.assign({},t.iconOptions,e.iconOptions),h=function(){n.arc(s[0],s[1],t.size||5,0,Math.PI*2),n.fillStyle=t.fillStyle||"red",n.fill()};let l=o.url;if(console.log("原始URL值:",l),typeof o.url=="function"){const y=e.properties&&e.properties.point_count||0;console.log("调用函数，聚合点数:",y),l=o.url(y),console.log("函数返回的URL:",l)}if(console.log("实际使用的图标URL:",l,"mapv图标"),!l){console.log("没有图标URL，绘制默认点"),h();return}let u=e.size||40,c=e.size||40;const d=e.properties&&e.properties.point_count||0;d>100?(u=50,c=50):d>50&&(u=45,c=45);const f=o.offset||{x:0,y:0};a=a-~~(u/2)+f.x,r=r-~~(c/2)+f.y;const p=typeof l=="string"?window.encodeURIComponent(l):"";if(!p){console.log("URL 编码失败，绘制默认点"),h();return}const g=it[p];if(g){if(g==="error"?(console.log("图片加载错误，绘制默认点"),h()):u&&c?(n.shadowBlur=o.shadowBlur,n.shadowColor=o.shadowColor,n.drawImage(g,a,r,u,c)):(n.shadowBlur=o.shadowBlur,n.shadowColor=o.shadowColor,n.drawImage(g,a,r)),t.iconOptions.show){n.fillStyle=t.fillStyle||"white",n.textBaseline="middle",n.textAlign="center";const y=e.properties&&e.properties.point_count||0,w=t.iconOptions.fontSize||Math.floor(u/6);n.font=`${w}px Arial`;const x=y.toString();if(x){const S=a+u/2,I=n.measureText(x),_=I.actualBoundingBoxAscent+I.actualBoundingBoxDescent,b=r+c/2+(I.actualBoundingBoxAscent-_/2);n.fillText(x,S,b)}}}else H[p]||(H[p]=[],console.log("开始加载图片:",l),ne(p,function(y,w){console.log("图片加载成功:",w),H[w]&&H[w].forEach(function(x){return x(y)}),H[w]=[],it[w]=y},function(y){console.log("图片加载失败:",y),H[y]&&H[y].forEach(function(w){return w("error")}),H[y]=[],it[y]="error",h()})),H[p].push((function(y,w,x,S){return function(I){if(I==="error"?(console.log("图片加载错误，绘制默认点"),h()):x&&S?(n.shadowBlur=o.shadowBlur,n.shadowColor=o.shadowColor,n.drawImage(I,y,w,x,S)):(n.shadowBlur=o.shadowBlur,n.shadowColor=o.shadowColor,n.drawImage(I,y,w)),t.iconOptions.show){n.fillStyle=t.fillStyle||"white",n.textBaseline="middle",n.textAlign="center";const _=e.properties&&e.properties.point_count||0,b=t.iconOptions.fontSize||Math.floor(x/6);n.font=`${b}px Arial`;const z=_.toString();if(z){const W=y+x/2,E=n.measureText(z),R=E.actualBoundingBoxAscent+E.actualBoundingBoxDescent,F=w+S/2+(E.actualBoundingBoxAscent-R/2);n.fillText(z,W,F)}}}})(a,r,u,c))}};function ie(i,e,t,n,s,a){const r=a.text||"",o=a.fontSize||"12px",h=a.fontColor||"black",l=o+" sans-serif",u=a.padding||5,c=a.backgroundColor||"white",d=a.borderColor||"black",f=a.borderWidth||1;i.font=l,i.fillStyle=h;const p=i.measureText(r).width,g=parseInt(o,10),y=p+2*u,w=g+2*u,x=function(E,R,F){return typeof E=="string"&&E.endsWith("%")?parseFloat(E)/100*R:typeof E=="number"?E:E==="center"?-R/2:F},S=x(a.top,w,-w/2),I=x(a.left,y,-y/2);x(a.right,y,y/2);const _=x(a.bottom,w,w/2);let b=e+I,z=t+S;a.bottom!==void 0&&(z=t-s/2-w-_),i.fillStyle=c,i.fillRect(b,z,y,w),a.border!==!1&&(i.strokeStyle=d,i.lineWidth=f,i.strokeRect(b,z,y,w)),i.fillStyle=h,i.fillText(r,b+u,z+u+g)}function ne(i,e,t){let n=new Image;n.onload=function(){e&&e(n,i)},n.onerror=function(){t&&t(i)},n.src=window.decodeURIComponent(i)}const oi={draw:function(i,e,t){const n=e instanceof O?e.get():e;i.save();for(const o in t)i[o]=t[o];const s=[],a=t._size||t.size;a?i.font="bold "+a+"px Arial":i.font="bold 12px Arial";const r=t.textKey||"text";if(t.textAlign||(i.textAlign="center"),t.textBaseline||(i.textBaseline="middle"),t.avoid)for(let o=0,h=n.length;o<h;o++){const l=n[o].offset||t.offset||{x:0,y:0},u=n[o];if(!u.geometry)continue;const c=u.geometry._coordinates||u.geometry.coordinates,d=c[0]+l.x,f=c[1]+l.y,p=u[r],g=i.measureText(p).width,y=d-g/2,w=f-(a||12)/2,x={sw:{x:y,y:w+(a||12)},ne:{x:y+g,y:w}};li(s,x)||(s.push(x),i.fillText(p,d,f))}else for(let o=0,h=n.length;o<h;o++){const l=n[o].offset||t.offset||{x:0,y:0},u=n[o];if(!u.geometry)continue;const c=u.geometry._coordinates||u.geometry.coordinates,d=c[0]+l.x,f=c[1]+l.y,p=u[r];i.fillText(p,d,f)}i.restore()}};function li(i,e){for(let t=0;t<i.length;t++)if(hi(i[t],e))return!0;return!1}function hi(i,e){const t=Math.min(i.ne.x,e.ne.x),n=Math.min(i.sw.y,e.sw.y),s=Math.max(i.sw.x,e.sw.x),a=Math.max(i.ne.y,e.ne.y);return t>s&&n>a}const nt={};let $={};const ui={draw:function(i,e,t){const n=e instanceof O?e.get():e;for(let s=0,a=n.length;s<a;s++){const r=n[s];if(r.geometry)if(r.properties&&r.properties.cluster)this.drawClusterIcon(r,t,i);else{const o=r.icon||t.icon;if(typeof o=="string"){const h=window.encodeURIComponent(o),l=nt[h];l?It(l,t,i,r):($[h]||($[h]=[],se(h,function(u,c){$[c]&&$[c].forEach(d=>d(u)),$[c]=null,nt[c]=u},function(u){$[u]&&$[u].forEach(c=>c("error")),$[u]=null,nt[u]="error"})),$[h].push(function(u){It(u,t,i,r)}))}else It(o,t,i,r)}}},drawClusterIcon:function(i,e,t){if(!i.geometry)return;const n=i.geometry._coordinates||i.geometry.coordinates,s=n[0],a=n[1],r=Object.assign({},e.iconOptions||{},i.iconOptions||{});if(r.show!==!1&&(r.url||i.icon)){let o="";if(typeof r.url=="function"){const h=i.properties&&i.properties.point_count||0;o=r.url(h)}else typeof r.url=="string"&&(o=r.url);if(o){const h=window.encodeURIComponent(o),l=nt[h];l?l==="error"?this.drawDefaultPoint(t,s,a,i,e):this.drawImageWithText(t,l,s,a,i,e,r):($[h]||($[h]=[],se(h,function(u,c){$[c]&&$[c].forEach(d=>d(u)),$[c]=null,nt[c]=u},function(u){$[u]&&$[u].forEach(c=>c("error")),$[u]=null,nt[u]="error"})),$[h].push(u=>{u==="error"?this.drawDefaultPoint(t,s,a,i,e):this.drawImageWithText(t,u,s,a,i,e,r)}));return}}this.drawDefaultClusterPoint(t,s,a,i,e)},drawDefaultPoint:function(i,e,t,n,s){i.beginPath(),i.arc(e,t,s.size||5,0,Math.PI*2),i.fillStyle=s.fillStyle||"rgba(255, 0, 0, 0.8)",i.fill()},drawImageWithText:function(i,e,t,n,s,a,r){i.save();let o=s.size||r.width||40,h=s.size||r.height||40;const l=s.properties&&s.properties.point_count||0;l>100?(o=50,h=50):l>50&&(o=45,h=45);const u=r.offset||{x:0,y:0};if(t=t-~~(o/2)+u.x,n=n-~~(h/2)+u.y,r.shadowBlur&&(i.shadowBlur=r.shadowBlur),r.shadowColor&&(i.shadowColor=r.shadowColor),i.drawImage(e,t,n,o,h),r.show!==!1){i.fillStyle=a.fillStyle||"white",i.textBaseline="middle",i.textAlign="center";const c=r.fontSize||Math.floor(o/6);i.font=`${c}px Arial`;const d=l.toString();if(d){const f=t+o/2,p=i.measureText(d),g=p.actualBoundingBoxAscent+p.actualBoundingBoxDescent,y=n+h/2+(p.actualBoundingBoxAscent-g/2);i.fillText(d,f,y)}}i.restore()},drawDefaultClusterPoint:function(i,e,t,n,s){i.save();let a=n.size||s.size||10;const r=n.properties&&n.properties.point_count||0;if(r>100?a=20:r>50?a=18:r>10&&(a=16),i.beginPath(),i.arc(e,t,a,0,Math.PI*2),r>100?i.fillStyle="rgba(255, 0, 0, 0.8)":r>50?i.fillStyle="rgba(255, 165, 0, 0.8)":r>10?i.fillStyle="rgba(255, 255, 0, 0.8)":i.fillStyle="rgba(0, 128, 0, 0.8)",i.fill(),i.strokeStyle="rgba(255, 255, 255, 0.8)",i.lineWidth=1,i.stroke(),s.label&&s.label.show!==!1){i.fillStyle=s.label.fillStyle||"white",i.textAlign="center",i.textBaseline="middle",i.font=s.label.font||"bold 12px Arial";const o=r.toString();i.fillText(o,e,t)}i.restore()}};function It(i,e,t,n){if(!n.geometry)return;t.save();const s=n.geometry._coordinates||n.geometry.coordinates,a=s[0],r=s[1],o=e.offset||{x:0,y:0},h=n.width||e._width||e.width,l=n.height||e._height||e.height,u=a-~~(h||0)/2+o.x,c=r-~~(l||0)/2+o.y;if(i==="error"){t.beginPath(),t.arc(u,c,e.size||5,0,Math.PI*2),t.fillStyle=e.fillStyle||"red",t.fill(),t.restore();return}const d=n.deg||e.deg;d&&(t.translate(u,c),t.rotate(d*Math.PI/180),t.translate(-u,-c)),e.sx!==void 0&&e.sy!==void 0&&e.swidth!==void 0&&e.sheight!==void 0&&e.width!==void 0&&e.height!==void 0?t.drawImage(i,e.sx,e.sy,e.swidth,e.sheight,u,c,h||0,l||0):h&&l?t.drawImage(i,u,c,h,l):t.drawImage(i,u,c),t.restore()}function se(i,e,t){const n=new Image;n.onload=function(){e&&e(n,i)},n.onerror=function(){t&&t(i)},n.src=window.decodeURIComponent(i)}function Tt(i,e,t,n,s,a){if(!(s-n<=t)){var r=n+s>>1;ae(i,e,r,n,s,a%2),Tt(i,e,t,n,r-1,a+1),Tt(i,e,t,r+1,s,a+1)}}function ae(i,e,t,n,s,a){for(;s>n;){if(s-n>600){var r=s-n+1,o=t-n+1,h=Math.log(r),l=.5*Math.exp(2*h/3),u=.5*Math.sqrt(h*l*(r-l)/r)*(o-r/2<0?-1:1),c=Math.max(n,Math.floor(t-o*l/r+u)),d=Math.min(s,Math.floor(t+(r-o)*l/r+u));ae(i,e,t,c,d,a)}var f=e[2*t+a],p=n,g=s;for(ht(i,e,n,t),e[2*s+a]>f&&ht(i,e,n,s);p<g;){for(ht(i,e,p,g),p++,g--;e[2*p+a]<f;)p++;for(;e[2*g+a]>f;)g--}e[2*n+a]===f?ht(i,e,n,g):(g++,ht(i,e,g,s)),g<=t&&(n=g+1),t<=g&&(s=g-1)}}function ht(i,e,t,n){Rt(i,t,n),Rt(e,2*t,2*n),Rt(e,2*t+1,2*n+1)}function Rt(i,e,t){var n=i[e];i[e]=i[t],i[t]=n}function ci(i,e,t,n,s,a,r){for(var o=[0,i.length-1,0],h=[],l,u;o.length;){var c=o.pop(),d=o.pop(),f=o.pop();if(d-f<=r){for(var p=f;p<=d;p++)l=e[2*p],u=e[2*p+1],l>=t&&l<=s&&u>=n&&u<=a&&h.push(i[p]);continue}var g=Math.floor((f+d)/2);l=e[2*g],u=e[2*g+1],l>=t&&l<=s&&u>=n&&u<=a&&h.push(i[g]);var y=(c+1)%2;(c===0?t<=l:n<=u)&&(o.push(f),o.push(g-1),o.push(y)),(c===0?s>=l:a>=u)&&(o.push(g+1),o.push(d),o.push(y))}return h}function fi(i,e,t,n,s,a){for(var r=[0,i.length-1,0],o=[],h=s*s;r.length;){var l=r.pop(),u=r.pop(),c=r.pop();if(u-c<=a){for(var d=c;d<=u;d++)re(e[2*d],e[2*d+1],t,n)<=h&&o.push(i[d]);continue}var f=Math.floor((c+u)/2),p=e[2*f],g=e[2*f+1];re(p,g,t,n)<=h&&o.push(i[f]);var y=(l+1)%2;(l===0?t-s<=p:n-s<=g)&&(r.push(c),r.push(f-1),r.push(y)),(l===0?t+s>=p:n+s>=g)&&(r.push(f+1),r.push(u),r.push(y))}return o}function re(i,e,t,n){var s=i-t,a=e-n;return s*s+a*a}var di=function(i){return i[0]},vi=function(i){return i[1]},yt=function(e,t,n,s,a){t===void 0&&(t=di),n===void 0&&(n=vi),s===void 0&&(s=64),a===void 0&&(a=Float64Array),this.nodeSize=s,this.points=e;for(var r=e.length<65536?Uint16Array:Uint32Array,o=this.ids=new r(e.length),h=this.coords=new a(e.length*2),l=0;l<e.length;l++)o[l]=l,h[2*l]=t(e[l]),h[2*l+1]=n(e[l]);Tt(o,h,s,0,o.length-1,0)};yt.prototype.range=function(e,t,n,s){return ci(this.ids,this.coords,e,t,n,s,this.nodeSize)},yt.prototype.within=function(e,t,n){return fi(this.ids,this.coords,e,t,n,this.nodeSize)};var pi={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:function(i){return i}},q=function(e){this.options=ut(Object.create(pi),e),this.trees=new Array(this.options.maxZoom+1)};q.prototype.load=function(e){var t=this.options,n=t.log,s=t.minZoom,a=t.maxZoom,r=t.nodeSize;n&&console.time("total time");var o="prepare "+e.length+" points";n&&console.time(o),this.points=e;for(var h=[],l=0;l<e.length;l++)e[l].geometry&&h.push(mi(e[l],l));this.trees[a+1]=new yt(h,he,ue,r,Float32Array),n&&console.timeEnd(o);for(var u=a;u>=s;u--){var c=+Date.now();h=this._cluster(h,u),this.trees[u]=new yt(h,he,ue,r,Float32Array),n&&console.log("z%d: %d clusters in %dms",u,h.length,+Date.now()-c)}return n&&console.timeEnd("total time"),this},q.prototype.getClusters=function(e,t){var n=((e[0]+180)%360+360)%360-180,s=Math.max(-90,Math.min(90,e[1])),a=e[2]===180?180:((e[2]+180)%360+360)%360-180,r=Math.max(-90,Math.min(90,e[3]));if(e[2]-e[0]>=360)n=-180,a=180;else if(n>a){var o=this.getClusters([n,s,180,r],t),h=this.getClusters([-180,s,a,r],t);return o.concat(h)}for(var l=this.trees[this._limitZoom(t)],u=l.range(At(n),Dt(r),At(a),Dt(s)),c=[],d=0,f=u;d<f.length;d+=1){var p=f[d],g=l.points[p];c.push(g.numPoints?oe(g):this.points[g.index])}return c},q.prototype.getChildren=function(e){var t=this._getOriginId(e),n=this._getOriginZoom(e),s="No cluster with the specified id.",a=this.trees[n];if(!a)throw new Error(s);var r=a.points[t];if(!r)throw new Error(s);for(var o=this.options.radius/(this.options.extent*Math.pow(2,n-1)),h=a.within(r.x,r.y,o),l=[],u=0,c=h;u<c.length;u+=1){var d=c[u],f=a.points[d];f.parentId===e&&l.push(f.numPoints?oe(f):this.points[f.index])}if(l.length===0)throw new Error(s);return l},q.prototype.getLeaves=function(e,t,n){t=t||10,n=n||0;var s=[];return this._appendLeaves(s,e,t,n,0),s},q.prototype.getTile=function(e,t,n){var s=this.trees[this._limitZoom(e)],a=Math.pow(2,e),r=this.options,o=r.extent,h=r.radius,l=h/o,u=(n-l)/a,c=(n+1+l)/a,d={features:[]};return this._addTileFeatures(s.range((t-l)/a,u,(t+1+l)/a,c),s.points,t,n,a,d),t===0&&this._addTileFeatures(s.range(1-l/a,u,1,c),s.points,a,n,a,d),t===a-1&&this._addTileFeatures(s.range(0,u,l/a,c),s.points,-1,n,a,d),d.features.length?d:null},q.prototype.getClusterExpansionZoom=function(e){for(var t=this._getOriginZoom(e)-1;t<=this.options.maxZoom;){var n=this.getChildren(e);if(t++,n.length!==1)break;e=n[0].properties.cluster_id}return t},q.prototype._appendLeaves=function(e,t,n,s,a){for(var r=this.getChildren(t),o=0,h=r;o<h.length;o+=1){var l=h[o],u=l.properties;if(u&&u.cluster?a+u.point_count<=s?a+=u.point_count:a=this._appendLeaves(e,u.cluster_id,n,s,a):a<s?a++:e.push(l),e.length===n)break}return a},q.prototype._addTileFeatures=function(e,t,n,s,a,r){for(var o=0,h=e;o<h.length;o+=1){var l=h[o],u=t[l],c=u.numPoints,d={type:1,geometry:[[Math.round(this.options.extent*(u.x*a-n)),Math.round(this.options.extent*(u.y*a-s))]],tags:c?le(u):this.points[u.index].properties},f=void 0;c?f=u.id:this.options.generateId?f=u.index:this.points[u.index].id&&(f=this.points[u.index].id),f!==void 0&&(d.id=f),r.features.push(d)}},q.prototype._limitZoom=function(e){return Math.max(this.options.minZoom,Math.min(+e,this.options.maxZoom+1))},q.prototype._cluster=function(e,t){for(var n=[],s=this.options,a=s.radius,r=s.extent,o=s.reduce,h=s.minPoints,l=a/(r*Math.pow(2,t)),u=0;u<e.length;u++){var c=e[u];if(!(c.zoom<=t)){c.zoom=t;for(var d=this.trees[t+1],f=d.within(c.x,c.y,l),p=c.numPoints||1,g=p,y=0,w=f;y<w.length;y+=1){var x=w[y],S=d.points[x];S.zoom>t&&(g+=S.numPoints||1)}if(g>=h){for(var I=c.x*p,_=c.y*p,b=o&&p>1?this._map(c,!0):null,z=(u<<5)+(t+1)+this.points.length,W=0,E=f;W<E.length;W+=1){var R=E[W],F=d.points[R];if(!(F.zoom<=t)){F.zoom=t;var wt=F.numPoints||1;I+=F.x*wt,_+=F.y*wt,F.parentId=z,o&&(b||(b=this._map(c,!0)),o(b,this._map(F)))}}c.parentId=z,n.push(gi(I/g,_/g,z,g,b))}else if(n.push(c),g>1)for(var ct=0,_t=f;ct<_t.length;ct+=1){var bt=_t[ct],ft=d.points[bt];ft.zoom<=t||(ft.zoom=t,n.push(ft))}}}return n},q.prototype._getOriginId=function(e){return e-this.points.length>>5},q.prototype._getOriginZoom=function(e){return(e-this.points.length)%32},q.prototype._map=function(e,t){if(e.numPoints)return t?ut({},e.properties):e.properties;var n=this.points[e.index].properties,s=this.options.map(n);return t&&s===n?ut({},s):s};function gi(i,e,t,n,s){return{x:i,y:e,zoom:1/0,id:t,parentId:-1,numPoints:n,properties:s}}function mi(i,e){var t=i.geometry.coordinates,n=t[0],s=t[1];return{x:At(n),y:Dt(s),zoom:1/0,index:e,parentId:-1}}function oe(i){return{type:"Feature",id:i.id,properties:le(i),geometry:{type:"Point",coordinates:[yi(i.x),wi(i.y)]}}}function le(i){var e=i.numPoints,t=e>=1e4?Math.round(e/1e3)+"k":e>=1e3?Math.round(e/100)/10+"k":e;return ut(ut({},i.properties),{cluster:!0,cluster_id:i.id,point_count:e,point_count_abbreviated:t})}function At(i){return i/360+.5}function Dt(i){var e=Math.sin(i*Math.PI/180),t=.5-.25*Math.log((1+e)/(1-e))/Math.PI;return t<0?0:t>1?1:t}function yi(i){return(i-.5)*360}function wi(i){var e=(180-i*360)*Math.PI/180;return 360*Math.atan(Math.exp(e))/Math.PI-90}function ut(i,e){for(var t in e)i[t]=e[t];return i}function he(i){return i.x}function ue(i){return i.y}class J{constructor(e,t,n){let s;t instanceof O?s=t:s=new O(t),this.dataSet=s,this.map=e,this.options=n,n.draw==="cluster"&&this.refreshCluster(n)}refreshCluster(e){e=e||this.options,this.supercluster=new q({maxZoom:e.maxZoom||19,radius:e.clusterRadius||100,minPoints:e.minPoints||2,extent:e.extent||512}),this.supercluster.load(this.dataSet.get()),this.supercluster.trees.forEach(t=>{let n=0,s=1/0;t.points.forEach(a=>{n=Math.max(a.numPoints||0,n),s=Math.min(a.numPoints||1/0,s)}),t.max=n,t.min=s}),this.clusterDataSet=new O}getDefaultContextConfig(){return{globalAlpha:1,globalCompositeOperation:"source-over",imageSmoothingEnabled:!0,strokeStyle:"#000000",fillStyle:"#000000",shadowOffsetX:0,shadowOffsetY:0,shadowBlur:0,shadowColor:"rgba(0, 0, 0, 0)",lineWidth:1,lineCap:"butt",lineJoin:"miter",miterLimit:10,lineDashOffset:0,font:"10px sans-serif",textAlign:"start",textBaseline:"alphabetic"}}initDataRange(e){const t=this;if(t.intensity=new tt({maxSize:t.options.maxSize,minSize:t.options.minSize,gradient:t.options.gradient,max:t.options.max||this.dataSet.getMax("count")}),t.category=new Kt(t.options.splitList||[]),t.choropleth=new Qt(t.options.splitList||[]),t.options.splitList===void 0&&t.category.generateByDataSet(this.dataSet,t.options.color),t.options.splitList===void 0){const n=t.options.min||this.dataSet.getMin("count")||0,s=t.options.max||this.dataSet.getMax("count")||100;t.choropleth.generateByMinMax(n,s)}}getLegend(e){this.options.draw;let t=null;const n=this;return n.options.draw==="intensity"||n.options.draw==="heatmap"?this.intensity?.getLegend(e):n.options.draw==="category"?this.category?.getLegend(e):n.options.draw==="choropleth"?this.choropleth?.getLegend(e):t}processData(e){const t=this,n=t.options.draw;if(n==="bubble"||n==="intensity"||n==="category"||n==="choropleth"||n==="simple")for(let s=0;s<e.length;s++){const a=e[s];t.options.draw==="bubble"?e[s]._size=t.intensity?.getSize(a.count):e[s]._size=void 0;let r="_fillStyle";(e[s].geometry?.type==="LineString"||t.options.styleType==="stroke")&&(r="_strokeStyle"),t.options.draw==="intensity"?e[s][r]=t.intensity?.getColor(a.count):t.options.draw==="category"?e[s][r]=t.category?.get(a.count):t.options.draw==="choropleth"&&(e[s][r]=t.choropleth?.get(a.count))}}isEnabledTime(){const e=this.options.animation;return!!(e&&e.enabled!==!1)}argCheck(e){e.draw==="heatmap"&&e.strokeStyle&&console.warn("[heatmap] options.strokeStyle is discard, pleause use options.strength [eg: options.strength = 0.1]")}drawContext(e,t,n,s){const a=this;switch(a.options.draw){case"heatmap":Zt.draw(e,t,a.options);break;case"grid":case"cluster":case"honeycomb":a.options.offset={x:s.x,y:s.y},a.options.draw==="grid"?Wt.draw(e,t,a.options):a.options.draw==="cluster"?ri.draw(e,t,a.options):Nt.draw(e,t,a.options);break;case"text":oi.draw(e,t,a.options);break;case"icon":ui.draw(e,t,a.options);break;case"clip":ai.draw(e,t,a.options);break;default:a.options.context==="webgl"?Jt.draw(e,t,a.options):a.options.enhancedDraw?Ct.drawEnhanced(e,t,a.options):Ct.draw(e,t,a.options)}a.options.arrow&&a.options.arrow.show!==!1&&ee.draw(e,t,a.options)}isPointInPath(e,t){const n=this.getContext(),s=this.getDefaultContextConfig();for(const r in s)n[r]=s[r];let a;this.options.draw==="cluster"&&(!this.options.maxClusterZoom||this.options.maxClusterZoom>=this.getZoom())?a=this.clusterDataSet?.get()||[]:a=this.dataSet.get();for(let r=0;r<a.length;r++){n.beginPath();const o=this.options,h=t.x*(this.canvasLayer?.devicePixelRatio||1),l=t.y*(this.canvasLayer?.devicePixelRatio||1);if(o.multiPolygonDraw=function(){return n.isPointInPath(h,l)?a[r]:null},Q.draw(n,a[r],o),a[r].geometry?.type?.indexOf("LineString")!==-1){if(n.isPointInStroke&&n.isPointInStroke(h,l))return a[r]}else if(n.isPointInPath(h,l))return a[r]}return null}getClusterPoints(e){return e.type!=="Feature"?[]:(this.supercluster?.getChildren(e.id)||[]).map(n=>n.type==="Feature"?this.getClusterPoints(n):n).flat()}getDataInBounds(e){const t=this.dataSet.get(),n=[];for(let s=0;s<t.length;s++){const a=t[s];if(a.geometry&&a.geometry.coordinates){const r=a.geometry.coordinates;e.contains(r)&&n.push(a)}}return n}filterData(e){if(typeof e=="function"){const t=this.dataSet.filter(e);return new O(t)}return this.dataSet}updateData(e){e instanceof O?this.dataSet=e:Array.isArray(e)&&this.dataSet.set(e),this.options.draw==="cluster"&&this.refreshCluster(this.options),this.initDataRange(this.options),this.draw()}addData(e){this.dataSet.add(e),this.options.draw==="cluster"&&this.refreshCluster(this.options),this.initDataRange(this.options),this.draw()}clearData(){this.dataSet.clear(),this.options.draw==="cluster"&&this.refreshCluster(this.options),this.draw()}getDataStats(){return{count:this.dataSet.get().length,minX:this.dataSet.getMin("x"),maxX:this.dataSet.getMax("x"),minY:this.dataSet.getMin("y"),maxY:this.dataSet.getMax("y"),minCount:this.dataSet.getMin("count"),maxCount:this.dataSet.getMax("count"),avgCount:this.dataSet.getAverage("count")}}clickEvent(e,t){if(!this.options.methods)return;const n=this.isPointInPath(this.getContext(),e);if(n){if(this.options.draw==="cluster"){const s=this.getClusterPoints(n);n.children=s}this.options.methods.click?.(n,t)}else this.options.methods.click?.(null,t)}mousemoveEvent(e,t){if(!this.options.methods)return;const n=this.isPointInPath(this.getContext(),e);if(n){if(this.options.draw==="cluster"){const s=this.getClusterPoints(n);n.children=s}this.options.methods.mousemove?.(n,t)}else this.options.methods.mousemove?.(null,t)}hoverEvent(e,t){if(!this.options.methods||!this.options.methods.hover)return;const n=this.isPointInPath(this.getContext(),e);if(n){if(this.options.draw==="cluster"){const s=this.getClusterPoints(n);n.children=s}this.options.methods.hover?.(n,t)}else this.options.methods.hover?.(null,t)}doubleClickEvent(e,t){if(!this.options.methods||!this.options.methods.doubleClick)return;const n=this.isPointInPath(this.getContext(),e);if(n){if(this.options.draw==="cluster"){const s=this.getClusterPoints(n);n.children=s}this.options.methods.doubleClick?.(n,t)}else this.options.methods.doubleClick?.(null,t)}tapEvent(e,t){if(!this.options.methods)return;const n=this.isPointInPath(this.getContext(),e);if(n){if(this.options.draw==="cluster"){const s=this.getClusterPoints(n);n.children=s}this.options.methods.tap?.(n,t)}else this.options.methods.tap?.(null,t)}update(e,t){const n=this,s=e.options,a=n.options;for(const r in s)a[r]=s[r];n.init(a),t!==!1&&n.draw()}updateOptions(e,t=!0){const n=this;for(const s in e)n.options[s]=e[s];(e.max!==void 0||e.min!==void 0||e.gradient!==void 0||e.splitList!==void 0)&&n.initDataRange(n.options),t&&n.draw()}setOptions(e){const t=this;t.dataSet.reset(),t.init(e),t.draw()}set(e){const t=this,n=this.getContext(),s=this.getDefaultContextConfig();for(const a in s)n[a]=s[a];t.init(e.options),t.draw()}destroy(){this.unbindEvent(),this.hide()}initAnimator(){const e=this,t=e.options.animation;if(e.options.draw==="time"||e.isEnabledTime()){t?.stepsRange||(t.stepsRange={start:this.dataSet.getMin("time")||0,end:this.dataSet.getMax("time")||0}),this.steps={step:t.stepsRange.start},e.animator=new U.Tween(this.steps).onUpdate(function(){e._canvasUpdate(this.step)}).repeat(1/0),this.addAnimatorEvent();const n=(t?.duration||5)*1e3;e.animator.to({step:t.stepsRange.end},n),e.animator.start()}else e.animator?.stop()}addAnimatorEvent(){}animatorMovestartEvent(){const e=this.options.animation;this.isEnabledTime()&&this.animator&&(this.steps.step=e.stepsRange.start,this.animator.stop())}animatorMoveendEvent(){this.isEnabledTime()&&this.animator&&this.animator.start()}toGeoJSON(){const e=this.dataSet.get(),t={type:"FeatureCollection",features:[]};return e.forEach(n=>{n.geometry&&t.features.push({type:"Feature",properties:Object.assign({},n),geometry:n.geometry})}),t}toCSV(){const e=this.dataSet.get();if(e.length===0)return"";const t=Object.keys(e[0]).filter(s=>s!=="geometry");let n=t.join(",")+`
`;return e.forEach(s=>{const a=t.map(r=>{let o=s[r];return typeof o=="object"&&(o=JSON.stringify(o)),typeof o=="string"&&(o.includes(",")||o.includes('"'))&&(o='"'+o.replace(/"/g,'""')+'"'),o});n+=a.join(",")+`
`}),n}init(e){}draw(){}getContext(){return null}getZoom(){return 0}unbindEvent(){}hide(){}_canvasUpdate(e){}}typeof window<"u"&&requestAnimationFrame(ce);function ce(i){requestAnimationFrame(ce),U.update(i)}var fe=typeof window>"u"?{}:window,_i=fe.BMap||fe.BMapGL;class bi extends J{constructor(e,t,n){super(e,t,n),this.map=e,this.options=n||{},this.dataSet=t;var s=new Y({map:e,zIndex:this.options.zIndex,update:this._canvasUpdate.bind(this)});this.animateLoopFrequency=0,this.init(this.options),this.canvasLayer=s,this.transferToMercator();var a=this;t.on("change",function(){a.transferToMercator(),s.draw()}),this.ctx=s.canvas.getContext("2d"),this.start()}draw(){this.canvasLayer.draw()}init(e){var t=this;t.options=e,this.initDataRange(e),this.context=t.options.context||"2d",t.options.zIndex&&this.canvasLayer&&this.canvasLayer.setZIndex(t.options.zIndex),t.options.max&&this.intensity.setMax(t.options.max),t.options.min&&this.intensity.setMin(t.options.min),this.initAnimator()}transferToMercator(){var e=this.map,t=e.getMapType(),n;if(t.getProjection?n=t.getProjection():n={lngLatToPoint:function(a){var r=e.lnglatToMercator(a.lng,a.lat);return{x:r[0],y:r[1]}}},this.options.coordType!=="bd09mc"){var s=this.dataSet.get();s=this.dataSet.transferCoordinate(s,function(a){var r=n.lngLatToPoint({lng:a[0],lat:a[1]});return[r.x,r.y]},"coordinates","coordinates_mercator"),this.dataSet._set(s)}}_canvasUpdate(){var e=this.ctx;if(e){var t=this.map,n,s;t.getMapType().getProjection?(n=t.getMapType().getProjection(),s=n.lngLatToPoint(t.getCenter())):(s={x:t.getCenter().lng,y:t.getCenter().lat},s.x>-180&&s.x<180&&(s=t.lnglatToMercator(s.x,s.y),s={x:s[0],y:s[1]}),n={lngLatToPoint:function(h){var l=t.lnglatToMercator(h.lng,h.lat);return{x:l[0],y:l[1]}}});var a;n.getZoomUnits?a=n.getZoomUnits(t.getZoom()):a=Math.pow(2,18-t.getZoom());var r=new _i.Pixel(s.x-t.getSize().width/2*a,s.y+t.getSize().height/2*a);G(e);var o={fromColumn:this.options.coordType=="bd09mc"?"coordinates":"coordinates_mercator",transferCoordinate:function(h){if(h){var l=(h[0]-r.x)/a,u=(r.y-h[1])/a;return[l,u]}}};this.data=this.dataSet.get(o),this.processData(this.data),this.drawAnimation()}}drawAnimation(){var e=this.ctx,t=this.data;if(t){e.save(),e.globalCompositeOperation="destination-out",e.fillStyle="rgba(0, 0, 0, .1)",e.fillRect(0,0,e.canvas.width,e.canvas.height),e.restore(),e.save(),this.options.shadowColor&&(e.shadowColor=this.options.shadowColor),this.options.shadowBlur&&(e.shadowBlur=this.options.shadowBlur),this.options.globalAlpha&&(e.globalAlpha=this.options.globalAlpha),this.options.globalCompositeOperation&&(e.globalCompositeOperation=this.options.globalCompositeOperation);for(var n=this.options,s=!1,a=0;a<t.length;a++)if(t[a].geometry.type==="Point"){e.beginPath();var r=t[a].size||this.options.size,o=t[a].minSize||this.options.minSize||0;t[a]._size===void 0&&(t[a]._size=o),e.arc(t[a].geometry._coordinates[0],t[a].geometry._coordinates[1],t[a]._size,0,Math.PI*2,!0),e.closePath(),t[a]._size++,t[a]._size>r&&(t[a]._size=o),e.lineWidth=1,e.strokeStyle=t[a].strokeStyle||t[a]._strokeStyle||n.strokeStyle||"yellow",e.stroke();var h=t[a].fillStyle||t[a]._fillStyle||n.fillStyle;h&&(e.fillStyle=h,e.fill())}else if(t[a].geometry.type==="LineString"){e.beginPath();var l=t[a].size||this.options.size||5,o=t[a].minSize||this.options.minSize||0;t[a]._index===void 0&&(t[a]._index=0);var u=t[a]._index;e.arc(t[a].geometry._coordinates[u][0],t[a].geometry._coordinates[u][1],l,0,Math.PI*2,!0),e.closePath(),t[a]._index=t[a]._index+(t[a]._step||1);var c=t[a].strokeStyle||n.strokeStyle,h=t[a].fillStyle||n.fillStyle||"yellow";e.fillStyle=h,e.fill(),c&&n.lineWidth&&(e.lineWidth=n.lineWidth||1,e.strokeStyle=c,e.stroke()),t[a]._index>=t[a].geometry._coordinates.length&&(n.isRound?(t[a]._step=-1,t[a]._index=t[a].geometry._coordinates.length-1):(t[a]._index=0,!s&&this.animateLoopFrequency++,s=!0)),t[a]._index<0&&n.isRound&&(t[a]._step=1,t[a]._index=0,!s&&this.animateLoopFrequency++,s=!0)}e.restore()}}animate(){var e=this.animateLoopFrequency;this.drawAnimation();var t=this.options.animateTime||100,n=this.options.stayTime;n&&this.animateLoopFrequency!=e?(this.hide(),this.timeout=setTimeout(()=>{this.canvasLayer.show(),this.animate()},n)):this.timeout=setTimeout(this.animate.bind(this),t);var s=null;if(this.options.times!==void 0&&this.animateLoopFrequency>=this.options.times){this.stop(),s&&clearTimeout(s),s=setTimeout(this.hide.bind(this),t);return}}start(){this.stop(),this.animate()}stop(){clearTimeout(this.timeout)}unbindEvent(){}hide(){this.canvasLayer.hide(),this.stop()}show(){this.start()}clearData(){this.dataSet&&this.dataSet.clear(),this.update({options:null})}destroy(){this.stop(),this.unbindEvent(),this.clearData(),this.map.removeOverlay(this.canvasLayer),this.canvasLayer=null}}var de=typeof window>"u"?{}:window,ve=de.BMap||de.BMapGL;let xi=class extends J{constructor(e,t,n){super(e,t,n);var s=this;n=n||{},this.clickEvent=this.clickEvent.bind(this),this.mousemoveEvent=this.mousemoveEvent.bind(this),this.tapEvent=this.tapEvent.bind(this),this.doubleClickEvent=this.doubleClickEvent.bind(this),s.init(n),s.argCheck(n),s.transferToMercator();var a=this.canvasLayer=new Y({map:e,context:this.context,updateImmediate:n.updateImmediate,paneName:n.paneName,mixBlendMode:n.mixBlendMode,enableMassClear:n.enableMassClear,zIndex:n.zIndex,update(){s._canvasUpdate()}});t.on("change",function(){s.transferToMercator(),n.draw==="cluster"&&s.refreshCluster(),a.draw()})}clickEvent(e){var t=e.pixel;super.clickEvent(t,e)}mousemoveEvent(e){var t=e.pixel;super.mousemoveEvent(t,e)}tapEvent(e){var t=e.pixel;super.tapEvent(t,e)}doubleClickEvent(e){var t=e.pixel;super.doubleClickEvent(t,e)}bindEvent(e){this.unbindEvent();var t=this.map,n=0,s=this;this.options.methods&&(this.options.methods.click&&(t.setDefaultCursor("default"),t.addEventListener("click",this.clickEvent)),this.options.methods.mousemove&&t.addEventListener("mousemove",this.mousemoveEvent),this.options.methods.hover&&(t.addEventListener("mouseover",this.mousemoveEvent),t.addEventListener("mouseout",this.mousemoveEvent)),this.options.methods.doubleClick&&t.addEventListener("dblclick",this.doubleClickEvent),"ontouchend"in window.document&&this.options.methods.tap&&(t.addEventListener("touchstart",function(a){n=new Date}),t.addEventListener("touchend",function(a){new Date-n<300&&s.tapEvent(a)})))}unbindEvent(e){var t=this.map;this.options.methods&&(this.options.methods.click&&t.removeEventListener("click",this.clickEvent),this.options.methods.mousemove&&t.removeEventListener("mousemove",this.mousemoveEvent),this.options.methods.hover&&(t.removeEventListener("mouseover",this.mousemoveEvent),t.removeEventListener("mouseout",this.mousemoveEvent)),this.options.methods.doubleClick&&t.removeEventListener("dblclick",this.doubleClickEvent))}transferToMercator(e){e||(e=this.dataSet);var t=this.map,n=t.getMapType(),s;if(n.getProjection?s=n.getProjection():s={lngLatToPoint:function(r){var o=t.lnglatToMercator(r.lng,r.lat);return{x:o[0],y:o[1]}}},this.options.coordType!=="bd09mc"){var a=e.get();a=e.transferCoordinate(a,function(r){if(r[0]<-180||r[0]>180||r[1]<-90||r[1]>90)return r;var o=s.lngLatToPoint({lng:r[0],lat:r[1]});return[o.x,o.y]},"coordinates","coordinates_mercator"),e._set(a)}}getContext(){return this.canvasLayer.canvas.getContext(this.context)}_canvasUpdate(e){if(this.canvasLayer){var t=this,n=this.options.animation,s=this.canvasLayer._map,a,r;s.getMapType().getProjection?(a=s.getMapType().getProjection(),r=a.lngLatToPoint(s.getCenter())):(r={x:s.getCenter().lng,y:s.getCenter().lat},r.x>-180&&r.x<180&&(r=s.lnglatToMercator(r.x,r.y),r={x:r[0],y:r[1]}),a={lngLatToPoint:function(E){var R=s.lnglatToMercator(E.lng,E.lat);return{x:R[0],y:R[1]}}});var o;a.getZoomUnits?o=a.getZoomUnits(s.getZoom()):o=Math.pow(2,18-s.getZoom());var h=new ve.Pixel(r.x-s.getSize().width/2*o,r.y+s.getSize().height/2*o),l=this.getContext();if(this.isEnabledTime()){if(e===void 0){G(l);return}this.context=="2d"&&(l.save(),l.globalCompositeOperation="destination-out",l.fillStyle="rgba(0, 0, 0, .1)",l.fillRect(0,0,l.canvas.width,l.canvas.height),l.restore())}else G(l);if(this.context=="2d")for(var u in this.options)l[u]=this.options[u];else l.clear(l.COLOR_BUFFER_BIT);if(!(this.options.minZoom&&s.getZoom()<this.options.minZoom||this.options.maxZoom&&s.getZoom()>this.options.maxZoom)){var c=1;this.context!="2d"&&(c=this.canvasLayer.devicePixelRatio);var d={fromColumn:this.options.coordType=="bd09mc"?"coordinates":"coordinates_mercator",transferCoordinate:function(E){var R=(E[0]-h.x)/o*c,F=(h.y-E[1])/o*c;return[R,F]}};e!==void 0&&(d.filter=function(E){var R=n.trails||10;return!!(e&&E.time>e-R&&E.time<e)});var f,p=this.getZoom();if(this.options.draw==="cluster"&&(!this.options.maxClusterZoom||this.options.maxClusterZoom>=p)){var g=this.map.getBounds(),y=g.getNorthEast(),w=g.getSouthWest(),x=this.supercluster.getClusters([w.lng,w.lat,y.lng,y.lat],p);this.pointCountMax=this.supercluster.trees[p].max,this.pointCountMin=this.supercluster.trees[p].min;var S={},I=null,_=null;this.pointCountMax===this.pointCountMin?(I=this.options.fillStyle,_=this.options.minSize||8):S=new tt({min:this.pointCountMin,max:this.pointCountMax,minSize:this.options.minSize||8,maxSize:this.options.maxSize||30,gradient:this.options.gradient});for(var b=0;b<x.length;b++){var z=x[b];z.properties&&z.properties.cluster_id?(x[b].size=_||S.getSize(z.properties.point_count),x[b].fillStyle=I||S.getColor(z.properties.point_count)):x[b].size=t.options.size}this.clusterDataSet.set(x),this.transferToMercator(this.clusterDataSet),f=t.clusterDataSet.get(d)}else f=t.dataSet.get(d);this.processData(f);var W=s.pointToPixel(new ve.Point(0,0));t.options.unit=="m"?(t.options.size&&(t.options._size=t.options.size/o),t.options.width&&(t.options._width=t.options.width/o),t.options.height&&(t.options._height=t.options.height/o)):(t.options._size=t.options.size,t.options._height=t.options.height,t.options._width=t.options.width),this.drawContext(l,f,t.options,W),t.options.updateCallback&&t.options.updateCallback(e)}}}init(e){var t=this;t.options=e,this.initDataRange(e),this.context=t.options.context||"2d",t.options.zIndex&&this.canvasLayer&&this.canvasLayer.setZIndex(t.options.zIndex),t.options.max&&this.intensity.setMax(t.options.max),t.options.min&&this.intensity.setMin(t.options.min),this.initAnimator(),this.bindEvent()}getZoom(){return this.map.getZoom()}addAnimatorEvent(){this.map.addEventListener("movestart",this.animatorMovestartEvent.bind(this)),this.map.addEventListener("moveend",this.animatorMoveendEvent.bind(this))}show(){this.map.addOverlay(this.canvasLayer),this.bindEvent()}hide(){this.unbindEvent(),this.map.removeOverlay(this.canvasLayer)}draw(){this.canvasLayer&&this.canvasLayer.draw()}clearData(){this.dataSet&&this.dataSet.clear(),this.update({options:null})}updateData(e){e instanceof DataSet?this.dataSet=e:Array.isArray(e)&&this.dataSet.set(e),this.options.draw==="cluster"&&this.refreshCluster(this.options),this.initDataRange(this.options),this.draw()}addData(e){this.dataSet.add(e),this.options.draw==="cluster"&&this.refreshCluster(this.options),this.initDataRange(this.options),this.draw()}getDataInBounds(){var e=this.map.getBounds(),t=e.getNorthEast(),n=e.getSouthWest(),s=[n.lng,n.lat,t.lng,t.lat],a=this.getZoom();return this.options.draw==="cluster"&&(!this.options.maxClusterZoom||this.options.maxClusterZoom>=a)?this.supercluster.getClusters(s,a):this.dataSet.get().filter(r=>{if(r.geometry&&r.geometry.coordinates){var o=r.geometry.coordinates;return o[0]>=n.lng&&o[0]<=t.lng&&o[1]>=n.lat&&o[1]<=t.lat}return!1})}setOpacity(e){this.canvasLayer&&this.canvasLayer.canvas&&(this.canvasLayer.canvas.style.opacity=e)}getOpacity(){return this.canvasLayer&&this.canvasLayer.canvas&&parseFloat(this.canvasLayer.canvas.style.opacity)||1}toggle(){if(this.canvasLayer&&this.canvasLayer.canvas){var e=this.canvasLayer.canvas;e.style.display=e.style.display==="none"?"block":"none"}}getLayerInfo(){return{zoom:this.getZoom(),visible:this.canvasLayer&&this.canvasLayer.canvas?this.canvasLayer.canvas.style.display!=="none":!0,opacity:this.getOpacity(),dataCount:this.dataSet?this.dataSet.getTotal():0,drawType:this.options.draw}}destroy(){this.unbindEvent(),this.clearData(),this.map.removeOverlay(this.canvasLayer),this.canvasLayer=null}};function B(i){this.isAdded_=!1,this.isAnimated_=!1,this.paneName_=B.DEFAULT_PANE_NAME_,this.updateHandler_=null,this.resizeHandler_=null,this.topLeft_=null,this.centerListener_=null,this.resizeListener_=null,this.needsResize_=!0,this.requestAnimationFrameId_=null;var e=document.createElement("canvas");e.style.position="absolute",e.style.top=0,e.style.left=0,e.style.pointerEvents="none",this.canvas=e,this.canvasCssWidth_=300,this.canvasCssHeight_=150,this.resolutionScale_=1;function t(n,s){return function(){s.apply(n)}}this.repositionFunction_=t(this,this.repositionCanvas_),this.resizeFunction_=t(this,this.resize_),this.requestUpdateFunction_=t(this,this.update_),i&&this.setOptions(i)}var V=typeof window>"u"?{}:window;V.google&&V.google.maps&&(B.prototype=new google.maps.OverlayView,B.DEFAULT_PANE_NAME_="overlayLayer",B.CSS_TRANSFORM_=(function(){for(var i=document.createElement("div"),e=["transform","WebkitTransform","MozTransform","OTransform","msTransform"],t=0;t<e.length;t++){var n=e[t];if(i.style[n]!==void 0)return n}return e[0]})(),B.prototype.requestAnimFrame_=V.requestAnimationFrame||V.webkitRequestAnimationFrame||V.mozRequestAnimationFrame||V.oRequestAnimationFrame||V.msRequestAnimationFrame||function(i){return V.setTimeout(i,1e3/60)},B.prototype.cancelAnimFrame_=V.cancelAnimationFrame||V.webkitCancelAnimationFrame||V.mozCancelAnimationFrame||V.oCancelAnimationFrame||V.msCancelAnimationFrame||function(i){},B.prototype.setOptions=function(i){i.animate!==void 0&&this.setAnimate(i.animate),i.paneName!==void 0&&this.setPaneName(i.paneName),i.updateHandler!==void 0&&this.setUpdateHandler(i.updateHandler),i.resizeHandler!==void 0&&this.setResizeHandler(i.resizeHandler),i.resolutionScale!==void 0&&this.setResolutionScale(i.resolutionScale),i.map!==void 0&&this.setMap(i.map)},B.prototype.setAnimate=function(i){this.isAnimated_=!!i,this.isAnimated_&&this.scheduleUpdate()},B.prototype.isAnimated=function(){return this.isAnimated_},B.prototype.setPaneName=function(i){this.paneName_=i,this.setPane_()},B.prototype.getPaneName=function(){return this.paneName_},B.prototype.setPane_=function(){if(this.isAdded_){var i=this.getPanes();if(!i[this.paneName_])throw new Error('"'+this.paneName_+'" is not a valid MapPane name.');i[this.paneName_].appendChild(this.canvas)}},B.prototype.setResizeHandler=function(i){this.resizeHandler_=i},B.prototype.setResolutionScale=function(i){typeof i=="number"&&(this.resolutionScale_=i,this.resize_())},B.prototype.setUpdateHandler=function(i){this.updateHandler_=i},B.prototype.onAdd=function(){this.isAdded_||(this.isAdded_=!0,this.setPane_(),this.resizeListener_=google.maps.event.addListener(this.getMap(),"resize",this.resizeFunction_),this.centerListener_=google.maps.event.addListener(this.getMap(),"center_changed",this.repositionFunction_),this.resize_(),this.repositionCanvas_())},B.prototype.onRemove=function(){this.isAdded_&&(this.isAdded_=!1,this.topLeft_=null,this.canvas.parentElement.removeChild(this.canvas),this.centerListener_&&(google.maps.event.removeListener(this.centerListener_),this.centerListener_=null),this.resizeListener_&&(google.maps.event.removeListener(this.resizeListener_),this.resizeListener_=null),this.requestAnimationFrameId_&&(this.cancelAnimFrame_.call(V,this.requestAnimationFrameId_),this.requestAnimationFrameId_=null))},B.prototype.resize_=function(){if(this.isAdded_){var i=this.getMap(),e=i.getDiv().offsetWidth,t=i.getDiv().offsetHeight,n=e*this.resolutionScale_,s=t*this.resolutionScale_,a=this.canvas.width,r=this.canvas.height;(a!==n||r!==s)&&(this.canvas.width=n,this.canvas.height=s,this.needsResize_=!0,this.scheduleUpdate()),(this.canvasCssWidth_!==e||this.canvasCssHeight_!==t)&&(this.canvasCssWidth_=e,this.canvasCssHeight_=t,this.canvas.style.width=e+"px",this.canvas.style.height=t+"px")}},B.prototype.draw=function(){this.repositionCanvas_()},B.prototype.repositionCanvas_=function(){var i=this.getMap(),e=i.getBounds().getNorthEast().lat(),t=i.getCenter(),n=Math.pow(2,i.getZoom()),s=t.lng()-this.canvasCssWidth_*180/(256*n);this.topLeft_=new google.maps.LatLng(e,s);var a=this.getProjection(),r=a.fromLatLngToDivPixel(t),o=-Math.round(this.canvasCssWidth_/2-r.x),h=-Math.round(this.canvasCssHeight_/2-r.y);this.canvas.style[B.CSS_TRANSFORM_]="translate("+o+"px,"+h+"px)",this.scheduleUpdate()},B.prototype.update_=function(){this.requestAnimationFrameId_=null,this.isAdded_&&(this.isAnimated_&&this.scheduleUpdate(),this.needsResize_&&this.resizeHandler_&&(this.needsResize_=!1,this.resizeHandler_()),this.updateHandler_&&this.updateHandler_())},B.prototype.getTopLeft=function(){return this.topLeft_},B.prototype.scheduleUpdate=function(){this.isAdded_&&!this.requestAnimationFrameId_&&(this.requestAnimationFrameId_=this.requestAnimFrame_.call(V,this.requestUpdateFunction_))});let Ci=class extends J{constructor(e,t,n){super(e,t,n);var s=this;n=n||{},s.init(n),s.argCheck(n);var a={map:e,animate:!1,updateHandler:function(){s._canvasUpdate()},resolutionScale};this.canvasLayer=new B(a),this.clickEvent=this.clickEvent.bind(this),this.mousemoveEvent=this.mousemoveEvent.bind(this),this.bindEvent()}clickEvent(e){var t=e.pixel;super.clickEvent(t,e)}mousemoveEvent(e){var t=e.pixel;super.mousemoveEvent(t,e)}bindEvent(e){var t=this.map;this.options.methods&&(this.options.methods.click&&(t.setDefaultCursor("default"),t.addListener("click",this.clickEvent)),this.options.methods.mousemove&&t.addListener("mousemove",this.mousemoveEvent))}unbindEvent(e){var t=this.map;this.options.methods&&(this.options.methods.click&&t.removeListener("click",this.clickEvent),this.options.methods.mousemove&&t.removeListener("mousemove",this.mousemoveEvent))}getContext(){return this.canvasLayer.canvas.getContext(this.context)}_canvasUpdate(e){if(this.canvasLayer){var t=this,n=t.options.animation,s=this.getContext();if(t.isEnabledTime()){if(e===void 0){G(s);return}this.context=="2d"&&(s.save(),s.globalCompositeOperation="destination-out",s.fillStyle="rgba(0, 0, 0, .1)",s.fillRect(0,0,s.canvas.width,s.canvas.height),s.restore())}else G(s);if(this.context=="2d")for(var a in t.options)s[a]=t.options[a];else s.clear(s.COLOR_BUFFER_BIT);if(!(t.options.minZoom&&r.getZoom()<t.options.minZoom||t.options.maxZoom&&r.getZoom()>t.options.maxZoom)){var h=1;this.context!="2d"&&(h=this.canvasLayer.devicePixelRatio);var r=this.map,o=r.getProjection(),h=Math.pow(2,r.zoom)*resolutionScale,l=o.fromLatLngToPoint(this.canvasLayer.getTopLeft()),u={transferCoordinate:function(g){var y=new google.maps.LatLng(g[1],g[0]),w=o.fromLatLngToPoint(y),x={x:(w.x-l.x)*h,y:(w.y-l.y)*h};return[x.x,x.y]}};e!==void 0&&(u.filter=function(g){var y=n.trails||10;return!!(e&&g.time>e-y&&g.time<e)});var c=t.dataSet.get(u);this.processData(c);var d=new google.maps.LatLng(0,0),f=o.fromLatLngToPoint(d),p={x:(f.x-l.x)*h,y:(f.y-l.y)*h};t.options.unit=="m"&&t.options.size?t.options._size=t.options.size/zoomUnit:t.options._size=t.options.size,this.drawContext(s,new O(c),t.options,p),t.options.updateCallback&&t.options.updateCallback(e)}}}init(e){var t=this;t.options=e,this.initDataRange(e),this.context=t.options.context||"2d",t.options.zIndex&&this.canvasLayer&&this.canvasLayer.setZIndex(t.options.zIndex),this.initAnimator()}addAnimatorEvent(){this.map.addListener("movestart",this.animatorMovestartEvent.bind(this)),this.map.addListener("moveend",this.animatorMoveendEvent.bind(this))}show(){this.map.addOverlay(this.canvasLayer)}hide(){this.map.removeOverlay(this.canvasLayer)}draw(){self.canvasLayer.draw()}},Bt;if(typeof maptalks<"u"){Bt=class extends maptalks.Layer{constructor(e,t,n){super(e,n),this.options_=n,this.dataSet=t,this._initBaseLayer(n)}_initBaseLayer(e){const t=this,n=this.baseLayer=new J(null,this.dataSet,e);t.init(e),n.argCheck(e)}clickEvent(e){if(!this.baseLayer)return;const t=e.containerPoint;this.baseLayer.clickEvent(t,e.domEvent)}mousemoveEvent(e){if(!this.baseLayer)return;const t=e.containerPoint;this.baseLayer.mousemoveEvent(t,e.domEvent)}getEvents(){return{click:this.clickEvent,mousemove:this.mousemoveEvent}}init(e){const t=this.baseLayer;t.options=e,t.initDataRange(e),t.context=t.options.context||"2d",t.initAnimator()}addAnimatorEvent(){this.map.addListener("movestart",this.animatorMovestartEvent.bind(this)),this.map.addListener("moveend",this.animatorMoveendEvent.bind(this))}};class i extends maptalks.renderer.CanvasRenderer{needToRedraw(){return this.layer.baseLayer.isEnabledTime()?!0:super.needToRedraw()}draw(){const t=this.layer.baseLayer;(!this.canvas||!t.isEnabledTime()||this._shouldClear)&&(this.prepareCanvas(),this._shouldClear=!1),this._update(this.gl||this.context,this._mapvFrameTime),delete this._mapvFrameTime,this.completeRender()}drawOnInteracting(){this.draw(),this._shouldClear=!1}onSkipDrawOnInteracting(){this._shouldClear=!0}_canvasUpdate(t){this.setToRedraw(),this._mapvFrameTime=t}_update(t,n){if(!this.canvas)return;const s=this.layer.baseLayer,a=s.options.animation,r=this.getMap();if(s.isEnabledTime()){if(n===void 0){G(t);return}s.context=="2d"&&(t.save(),t.globalCompositeOperation="destination-out",t.fillStyle="rgba(0, 0, 0, .1)",t.fillRect(0,0,t.canvas.width,t.canvas.height),t.restore())}else G(t);if(s.context=="2d")for(const f in s.options)t[f]=s.options[f];else t.clear(t.COLOR_BUFFER_BIT);const o=1,h=new maptalks.Coordinate(0,0),l={fromColumn:s.options.coordType==="bd09mc"?"coordinates_mercator":"coordinates",transferCoordinate:function(f){return h.x=f[0],h.y=f[1],r.coordToContainerPoint(h)._multi(o).toArray()}};n!==void 0&&(l.filter=function(f){const p=a.trails||10;return!!(n&&f.time>n-p&&f.time<n)});const u=s.dataSet.get(l);s.processData(u),s.options.unit=="m"?(s.options.size&&(s.options._size=s.options.size/zoomUnit),s.options.width&&(s.options._width=s.options.width/zoomUnit),s.options.height&&(s.options._height=s.options.height/zoomUnit)):(s.options._size=s.options.size,s.options._height=s.options.height,s.options._width=s.options.width);const c=new maptalks.Point(0,0),d=r._pointToContainerPoint(c)._multi(o);s.drawContext(t,u,s.options,d),s.options.updateCallback&&s.options.updateCallback(n)}createCanvas(){if(this.canvas)return;const t=this.getMap(),n=t.getSize(),s=t.getDevicePixelRatio?t.getDevicePixelRatio():maptalks.Browser.retina?2:1,a=s*n.width,r=s*n.height;if(this.canvas=maptalks.Canvas.createCanvas(a,r,t.CanvasClass),this.layer.baseLayer.context==="2d")this.context=this.canvas.getContext("2d"),this.layer.options.globalCompositeOperation&&(this.context.globalCompositeOperation=this.layer.options.globalCompositeOperation),this.layer.baseLayer.options.draw!=="heatmap"&&s!==1&&this.context.scale(s,s);else{const h={alpha:!0,preserveDrawingBuffer:!0,antialias:!1};this.gl=this.canvas.getContext("webgl",h)}this.onCanvasCreate(),this._bindToMapv(),this.layer.fire("canvascreate",{context:this.context,gl:this.gl})}_bindToMapv(){const t=this.layer.baseLayer,n=this.getMap();this.devicePixelRatio=n.getDevicePixelRatio?n.getDevicePixelRatio():maptalks.Browser.retina?2:1,t.canvasLayer=this,t._canvasUpdate=this._canvasUpdate.bind(this),t.getContext=function(){const s=self.getRenderer();return s.gl||s.context}}}Bt.registerRenderer("canvas",i)}const Li=Bt,Si=(i,e,t)=>{if(typeof document<"u"){const n=document.createElement("canvas");return n.width=i,n.height=e,n}else return new t(i,e)};let Ei=class extends J{constructor(e=null,t,n){super(e,t,n),this.options=n,this.canvasLayer={canvas:null,devicePixelRatio:window.devicePixelRatio},this.layer_=null,this.initDataRange(n),this.initAnimator(),this.onEvents(),e.on("complete",function(){this.init(e,n),this.argCheck(n)},this)}init(e,t){if(e)this.map=e,this.context=this.options.context||"2d",this.getCanvasLayer();else throw new Error("not map object")}_canvasUpdate(e){this.render(this.canvasLayer.canvas,e)}render(e,t){if(!e)return;const n=this.map,s=e.getContext(this.context),a=this.options.animation;if(this.isEnabledTime()){if(t===void 0)return G(s),this;this.context==="2d"&&(s.save(),s.globalCompositeOperation="destination-out",s.fillStyle="rgba(0, 0, 0, .1)",s.fillRect(0,0,s.canvas.width,s.canvas.height),s.restore())}else G(s);if(this.context==="2d")for(const h in this.options)s[h]=this.options[h];else s.clear(s.COLOR_BUFFER_BIT);const r={transferCoordinate:function(h){const l=n.lngLatToContainer(new AMap.LngLat(h[0],h[1]));return[l.x,l.y]}};t!==void 0&&(r.filter=function(h){const l=a.trails||10;return!!(t&&h.time>t-l&&h.time<t)});const o=this.dataSet.get(r);return this.processData(o),this.options.unit==="m"?(this.options.size&&(this.options._size=this.options.size/zoomUnit),this.options.width&&(this.options._width=this.options.width/zoomUnit),this.options.height&&(this.options._height=this.options.height/zoomUnit)):(this.options._size=this.options.size,this.options._height=this.options.height,this.options._width=this.options.width),this.drawContext(s,new O(o),this.options,{x:0,y:0}),this.options.updateCallback&&this.options.updateCallback(t),this}getCanvasLayer(){if(!this.canvasLayer.canvas&&!this.layer_){const e=this.canvasFunction(),t=this.map.getBounds();this.layer_=new AMap.CanvasLayer({canvas:e,bounds:this.options.bounds||t,zooms:this.options.zooms||[0,22]}),this.layer_.setMap(this.map),this.map.on("mapmove",this.canvasFunction,this),this.map.on("zoomchange",this.canvasFunction,this)}}canvasFunction(){const[e,t]=[this.map.getSize().width,this.map.getSize().height];if(!this.canvasLayer.canvas)this.canvasLayer.canvas=Si(e,t);else{this.canvasLayer.canvas.width=e,this.canvasLayer.canvas.height=t;const n=this.map.getBounds();this.layer_&&this.layer_.setBounds(this.options.bounds||n)}return this.render(this.canvasLayer.canvas),this.canvasLayer.canvas}removeLayer(){this.map&&(this.unEvents(),this.map.removeLayer(this.layer_),delete this.map,delete this.layer_,delete this.canvasLayer.canvas)}getContext(){return this.canvasLayer.canvas.getContext(this.context)}clickEvent(e){const t=e.pixel;super.clickEvent(t,e)}mousemoveEvent(e){const t=e.pixel;super.mousemoveEvent(t,e)}addAnimatorEvent(){this.map.on("movestart",this.animatorMovestartEvent,this),this.map.on("moveend",this.animatorMoveendEvent,this)}onEvents(){const e=this.map;this.unEvents(),this.options.methods&&(this.options.methods.click&&e.on("click",this.clickEvent,this),this.options.methods.mousemove&&e.on("mousemove",this.mousemoveEvent,this))}unEvents(){const e=this.map;this.options.methods&&(this.options.methods.click&&e.off("click",this.clickEvent,this),this.options.methods.mousemove&&e.off("mousemove",this.mousemoveEvent,this))}};const Mi=(i,e)=>{if(typeof document<"u"){const t=document.createElement("canvas");return t.width=i,t.height=e,t}};class Pi extends J{constructor(e=null,t,n){super(e,t,n),this.options=n,this.canvasLayer={canvas:null,devicePixelRatio:window.devicePixelRatio},this.layer_=null,this.previousCursor_=void 0,this.init(e,n),this.argCheck(n)}init(e,t){if(e&&e instanceof ol.Map)this.$Map=e,this.context=this.options.context||"2d",this.getCanvasLayer(),this.initDataRange(t),this.initAnimator(),this.onEvents();else throw new Error("not map object")}_canvasUpdate(e){this.render(this.canvasLayer.canvas,e)}render(e,t){const n=this.$Map,s=e.getContext(this.context),a=this.options.animation,r=this.options.hasOwnProperty("projection")?this.options.projection:"EPSG:4326",o=this.$Map.getView().getProjection().getCode();if(this.isEnabledTime()){if(t===void 0)return G(s),this;this.context==="2d"&&(s.save(),s.globalCompositeOperation="destination-out",s.fillStyle="rgba(0, 0, 0, .1)",s.fillRect(0,0,s.canvas.width,s.canvas.height),s.restore())}else G(s);if(this.context==="2d")for(const u in this.options)s[u]=this.options[u];else s.clear(s.COLOR_BUFFER_BIT);const h={};h.transferCoordinate=r===o?function(u){return n.getPixelFromCoordinate(u)}:function(u){return n.getPixelFromCoordinate(ol.proj.transform(u,r,o))},t!==void 0&&(h.filter=function(u){const c=a.trails||10;return!!(t&&u.time>t-c&&u.time<t)});const l=this.dataSet.get(h);return this.processData(l),this.options.unit==="m"?(this.options.size&&(this.options._size=this.options.size/zoomUnit),this.options.width&&(this.options._width=this.options.width/zoomUnit),this.options.height&&(this.options._height=this.options.height/zoomUnit)):(this.options._size=this.options.size,this.options._height=this.options.height,this.options._width=this.options.width),this.drawContext(s,new O(l),this.options,{x:0,y:0}),this.options.updateCallback&&this.options.updateCallback(t),this}getCanvasLayer(){if(!this.canvasLayer.canvas&&!this.layer_){const e=this.getMapExtent();this.layer_=new ol.layer.Image({layerName:this.options.layerName,minResolution:this.options.minResolution,maxResolution:this.options.maxResolution,zIndex:this.options.zIndex,extent:e,source:new ol.source.ImageCanvas({canvasFunction:this.canvasFunction.bind(this),projection:this.$Map.getView().getProjection().getCode(),ratio:this.options.hasOwnProperty("ratio")?this.options.ratio:1})}),this.$Map.addLayer(this.layer_),this.$Map.un("precompose",this.reRender,this),this.$Map.on("precompose",this.reRender,this)}}reRender(){if(!this.layer_)return;const e=this.getMapExtent();this.layer_.setExtent(e)}canvasFunction(e,t,n,s,a){return this.canvasLayer.canvas?(this.canvasLayer.canvas.width=s[0],this.canvasLayer.canvas.height=s[1]):this.canvasLayer.canvas=Mi(s[0],s[1]),this.render(this.canvasLayer.canvas),this.canvasLayer.canvas}getMapExtent(){const e=this.$Map.getSize();return this.$Map.getView().calculateExtent(e)}addTo(e){this.init(e,this.options)}removeLayer(){this.$Map&&(this.unEvents(),this.$Map.un("precompose",this.reRender,this),this.$Map.removeLayer(this.layer_),delete this.$Map,delete this.layer_,delete this.canvasLayer.canvas)}getContext(){return this.canvasLayer.canvas.getContext(this.context)}clickEvent(e){const t=e.pixel;super.clickEvent({x:t[0],y:t[1]},e)}mousemoveEvent(e){const t=e.pixel;super.mousemoveEvent({x:t[0],y:t[1]},e)}addAnimatorEvent(){this.$Map.on("movestart",this.animatorMovestartEvent,this),this.$Map.on("moveend",this.animatorMoveendEvent,this)}onEvents(){const e=this.$Map;this.unEvents(),this.options.methods&&(this.options.methods.click&&e.on("click",this.clickEvent,this),this.options.methods.mousemove&&e.on("pointermove",this.mousemoveEvent,this))}unEvents(){const e=this.$Map;this.options.methods&&(this.options.methods.click&&e.un("click",this.clickEvent,this),this.options.methods.pointermove&&e.un("pointermove",this.mousemoveEvent,this))}setDefaultCursor(e,t){if(!this.$Map)return;const n=this.$Map.getTargetElement();t?n.style.cursor!==e&&(this.previousCursor_=n.style.cursor,n.style.cursor=e):this.previousCursor_!==void 0&&(n.style.cursor=this.previousCursor_,this.previousCursor_=void 0)}show(){this.$Map.addLayer(this.layer_)}hide(){this.$Map.removeLayer(this.layer_)}}let zi=class extends J{constructor(e,t,n,s){if(super(e,n,s),!!J){var a=this;s=s||{},a.init(s),a.argCheck(s),this.canvasLayer=t,this.clickEvent=this.clickEvent.bind(this),this.mousemoveEvent=this.mousemoveEvent.bind(this),this._moveStartEvent=this.moveStartEvent.bind(this),this._moveEndEvent=this.moveEndEvent.bind(this),this._zoomStartEvent=this.zoomStartEvent.bind(this),this.bindEvent()}}clickEvent(e){var t=this.map.containerPointToLayerPoint([0,0]),n=this.devicePixelRatio=this.canvasLayer.devicePixelRatio=window.devicePixelRatio,s=e.layerPoint;super.clickEvent(L.point((s.x-t.x)/n,(s.y-t.y)/n),e)}mousemoveEvent(e){var t=e.layerPoint;super.mousemoveEvent(t,e)}bindEvent(){var e=this.map;this.options.methods&&(this.options.methods.click&&e.on("click",this.clickEvent),this.options.methods.mousemove&&e.on("mousemove",this.mousemoveEvent)),this.map.on("movestart",this._moveStartEvent),this.map.on("moveend",this._moveEndEvent),this.map.on("zoomstart",this._zoomStartEvent)}destroy(){this.unbindEvent(),this.clearData(),this.animator&&this.animator.stop(),this.animator=null,this.canvasLayer=null}unbindEvent(){var e=this.map;this.options.methods&&(this.options.methods.click&&e.off("click",this.clickEvent),this.options.methods.mousemove&&e.off("mousemove",this.mousemoveEvent)),this.map.off("movestart",this._moveStartEvent),this.map.off("moveend",this._moveEndEvent),this.map.off("zoomstart",this._zoomStartEvent)}getContext(){return this.canvasLayer.getCanvas().getContext(this.context)}addData(e,t){var n=e;e&&e.get&&(n=e.get()),this.dataSet.add(n),this.update({options:t})}update(e){var t=e||{},n=t.data;n&&n.get&&(n=n.get()),n!=null&&this.dataSet.set(n),super.update({options:t.options})}getData(){return this.dataSet}removeData(e){if(this.dataSet){var t=this.dataSet.get({filter:function(n){return e!=null&&typeof e=="function"?!e(n):!0}});this.dataSet.set(t),this.update({options:null})}}clearData(){this.dataSet&&this.dataSet.clear(),this.update({options:null})}_canvasUpdate(e){if(this.canvasLayer){var t=this,n=t.options.animation,s=this.getContext(),a=this.map;if(t.isEnabledTime()){if(e===void 0){this.clear(s);return}this.context==="2d"&&(s.save(),s.globalCompositeOperation="destination-out",s.fillStyle="rgba(0, 0, 0, .1)",s.fillRect(0,0,s.canvas.width,s.canvas.height),s.restore())}else this.clear(s);if(this.context==="2d")for(var r in t.options)s[r]=t.options[r];else s.clear(s.COLOR_BUFFER_BIT);if(!(t.options.minZoom&&a.getZoom()<t.options.minZoom||t.options.maxZoom&&a.getZoom()>t.options.maxZoom)){var o=a.getBounds(),h=o.getEast()-o.getWest(),l=o.getNorth()-o.getSouth(),u=a.getSize(),c=h/u.x,d=l/u.y,f=this.canvasLayer.getTopLeft(),p=a.latLngToContainerPoint(f),g={transferCoordinate:function(S){var I;t.context==="2d"?I=a.latLngToContainerPoint(L.latLng(S[1],S[0])):I={x:(S[0]-f.lng)/c,y:(f.lat-S[1])/d};var _={x:I.x-p.x,y:I.y-p.y};return[_.x,_.y]}};e!==void 0&&(g.filter=function(S){var I=n.trails||10;return e&&S.time>e-I&&S.time<e});var y=t.dataSet.get(g);this.processData(y),t.options._size=t.options.size;var w=a.latLngToContainerPoint(L.latLng(0,0)),x={x:w.x-p.x,y:w.y-p.y};this.drawContext(s,y,t.options,x),t.options.updateCallback&&t.options.updateCallback(e)}}}init(e){var t=this;t.options=e,this.initDataRange(e),this.context=t.options.context||"2d",t.options.zIndex&&this.canvasLayer&&this.canvasLayer.setZIndex(t.options.zIndex),this.initAnimator()}addAnimatorEvent(){}moveStartEvent(){var e=this.options.animation;this.isEnabledTime()&&this.animator&&(this.steps.step=e.stepsRange.start,this._hide())}moveEndEvent(){this.canvasLayer.draw(),this._show()}zoomStartEvent(){this._hide()}clear(e){e&&e.clearRect&&e.clearRect(0,0,e.canvas.width,e.canvas.height)}_hide(){this.canvasLayer.canvas.style.display="none"}_show(){this.canvasLayer.canvas.style.display="block"}draw(){this.canvasLayer.draw()}};var pe;if(typeof L<"u"){var Ii=L.Layer.extend({options:{attributionPrefix:null,attribution:""},initialize:function(i,e,t){t=t||{},this.dataSet=i||{},this.mapVOptions=e||{},this.render=this.render.bind(this),L.Util.setOptions(this,t),this.options.attributionPrefix&&(this.options.attribution=this.options.attributionPrefix+this.options.attribution),this.canvas=this._createCanvas(),L.stamp(this)},onAdd:function(i){this._map=i;var e=this.getPane(),t=this.container=L.DomUtil.create("div","leaflet-layer leaflet-zoom-animated",e);t.appendChild(this.canvas);var n=i.getSize();t.style.width=n.x+"px",t.style.height=n.y+"px",this.renderer=new zi(i,this,this.dataSet,this.mapVOptions),this.draw(),this.fire("loaded")},onRemove:function(){L.DomUtil.remove(this.container),this.renderer.destroy()},addData:function(i,e){this.renderer.addData(i,e)},update:function(i){this.renderer.update(i)},getData:function(){return this.renderer&&(this.dataSet=this.renderer.getData()),this.dataSet},removeData:function(i){this.renderer&&this.renderer.removeData(i)},clearData:function(){this.renderer.clearData()},draw:function(){return this._reset()},setZIndex:function(i){this.canvas.style.zIndex=i},render:function(){this.renderer._canvasUpdate()},getCanvas:function(){return this.canvas},getContainer:function(){return this.container},getTopLeft:function(){var i=this._map,e;if(i){var t=i.getBounds();e=t.getNorthWest()}return e},_createCanvas:function(){var i=document.createElement("canvas");i.style.position="absolute",i.style.top="0px",i.style.left="0px",i.style.pointerEvents="none",i.style.zIndex=this.options.zIndex||600;var e=typeof window>"u"?{}:window,t=this.devicePixelRatio=e.devicePixelRatio;return(!this.mapVOptions.context||this.mapVOptions.context==="2d")&&i.getContext("2d").scale(t,t),i},_resize:function(){var i=this.canvas;if(i){var e=this._map,t=e.getSize();i.width=t.x,i.height=t.y,i.style.width=t.x+"px",i.style.height=t.y+"px";var n=e.getBounds(),s=e.latLngToLayerPoint(n.getNorthWest());L.DomUtil.setPosition(i,s)}},_reset:function(){this._resize(),this._render()},redraw:function(){this._resize(),this._render()},_render:function(){this.render()}});pe=function(i,e,t){return new Ii(i,e,t)}}const Ti=pe;class Ri extends J{constructor(e,t,n,s){super(e,t,n),J&&(this.map=e,this.scene=e.scene,this.dataSet=t,n=n||{},this.init(n),this.argCheck(n),this.initDevicePixelRatio(),this.canvasLayer=s,this.stopAniamation=!1,this.animation=n.animation,this.clickEvent=this.clickEvent.bind(this),this.mousemoveEvent=this.mousemoveEvent.bind(this),this.bindEvent())}initDevicePixelRatio(){this.devicePixelRatio=window.devicePixelRatio||1}clickEvent(e){var t=e.point;super.clickEvent(t,e)}mousemoveEvent(e){var t=e.point;super.mousemoveEvent(t,e)}addAnimatorEvent(){}animatorMovestartEvent(){var e=this.options.animation;this.isEnabledTime()&&this.animator&&(this.steps.step=e.stepsRange.start)}animatorMoveendEvent(){this.isEnabledTime()&&this.animator}bindEvent(){this.map,this.options.methods&&(this.options.methods.click,this.options.methods.mousemove)}unbindEvent(){var e=this.map;this.options.methods&&(this.options.methods.click&&e.off("click",this.clickEvent),this.options.methods.mousemove&&e.off("mousemove",this.mousemoveEvent))}getContext(){return this.canvasLayer.canvas.getContext(this.context)}init(e){this.options=e,this.initDataRange(e),this.context=this.options.context||"2d",this.options.zIndex&&this.canvasLayer&&this.canvasLayer.setZIndex(this.options.zIndex),this.initAnimator()}_canvasUpdate(e){this.map;var t=this.scene;if(this.canvasLayer&&!this.stopAniamation){var n=this.options.animation,s=this.getContext();if(this.isEnabledTime()){if(e===void 0)return void this.clear(s);this.context==="2d"&&(s.save(),s.globalCompositeOperation="destination-out",s.fillStyle="rgba(0, 0, 0, .1)",s.fillRect(0,0,s.canvas.width,s.canvas.height),s.restore())}else this.clear(s);if(this.context==="2d")for(var a in this.options)s[a]=this.options[a];else s.clear(s.COLOR_BUFFER_BIT);var r={transferCoordinate:function(l){var u=Cesium.Cartesian3.fromDegrees(l[0],l[1]),c=Cesium.SceneTransforms.wgs84ToWindowCoordinates(t,u);return c==null?[-1,-1]:[c.x,c.y]}};e!==void 0&&(r.filter=function(l){var u=n.trails||10;return!!(e&&l.time>e-u&&l.time<e)});var o=this.dataSet.get(r);this.processData(o),this.options.unit=="m"&&this.options.size,this.options._size=this.options.size;var h=Cesium.SceneTransforms.wgs84ToWindowCoordinates(t,Cesium.Cartesian3.fromDegrees(0,0));this.drawContext(s,new O(o),this.options,h),this.options.updateCallback&&this.options.updateCallback(e)}}updateData(e,t){var n=e;n&&n.get&&(n=n.get()),n!=null&&this.dataSet.set(n),super.update({options:t})}addData(e,t){var n=e;e&&e.get&&(n=e.get()),this.dataSet.add(n),this.update({options:t})}getData(){return this.dataSet}removeData(e){if(this.dataSet){var t=this.dataSet.get({filter:function(n){return e==null||typeof e!="function"||!e(n)}});this.dataSet.set(t),this.update({options:null})}}clearData(){this.dataSet&&this.dataSet.clear(),this.update({options:null})}draw(){this.canvasLayer.draw()}clear(e){e&&e.clearRect&&e.clearRect(0,0,e.canvas.width,e.canvas.height)}}var ge;if(typeof Cesium<"u"){var Ai=0;Cesium;class i{constructor(t,n,s,a){if(this.map=t,this.scene=t.scene,this.mapvBaseLayer=new Ri(t,n,s,this),this.mapVOptions=s,this.initDevicePixelRatio(),this.canvas=this._createCanvas(),this.render=this.render.bind(this),a)this.container=a;else{const r=t.container.querySelector(".cesium-viewer-cesiumWidgetContainer");this.container=r||t.container}this.addInnerContainer(),this.bindEvent(),this._reset()}initDevicePixelRatio(){this.devicePixelRatio=window.devicePixelRatio||1}addInnerContainer(){this.container.appendChild(this.canvas)}bindEvent(){var t=this;this.innerMoveStart=this.moveStartEvent.bind(this),this.innerMoveEnd=this.moveEndEvent.bind(this),this.scene.camera.moveStart.addEventListener(this.innerMoveStart,this),this.scene.camera.moveEnd.addEventListener(this.innerMoveEnd,this);var n=new Cesium.ScreenSpaceEventHandler(this.scene.canvas);n.setInputAction(function(s){t.innerMoveEnd()},Cesium.ScreenSpaceEventType.LEFT_UP),n.setInputAction(function(s){t.innerMoveEnd()},Cesium.ScreenSpaceEventType.MIDDLE_UP),this.handler=n}unbindEvent(){this.scene.camera.moveStart.removeEventListener(this.innerMoveStart,this),this.scene.camera.moveEnd.removeEventListener(this.innerMoveEnd,this),this.scene.postRender.removeEventListener(this._reset,this),this.handler&&(this.handler.destroy(),this.handler=null)}moveStartEvent(){this.mapvBaseLayer&&(this.mapvBaseLayer.animatorMovestartEvent(),this.scene.postRender.addEventListener(this._reset,this))}moveEndEvent(){this.mapvBaseLayer&&(this.scene.postRender.removeEventListener(this._reset,this),this.mapvBaseLayer.animatorMoveendEvent(),this._reset())}zoomStartEvent(){this._unvisiable()}zoomEndEvent(){this._unvisiable()}addData(t,n){this.mapvBaseLayer!=null&&this.mapvBaseLayer.addData(t,n)}updateData(t,n){this.mapvBaseLayer!=null&&this.mapvBaseLayer.updateData(t,n)}getData(){return this.mapvBaseLayer&&(this.dataSet=this.mapvBaseLayer.getData()),this.dataSet}removeData(t){this.mapvBaseLayer!=null&&this.mapvBaseLayer&&this.mapvBaseLayer.removeData(t)}removeAllData(){this.mapvBaseLayer!=null&&this.mapvBaseLayer.clearData()}_visiable(){return this.canvas.style.display="block",this}_unvisiable(){return this.canvas.style.display="none",this}_createCanvas(){var t=document.createElement("canvas");t.id=this.mapVOptions.layerid||"mapv"+Ai++,t.style.position="absolute",t.style.top="0px",t.style.left="0px",t.style.pointerEvents="none",t.style.zIndex=this.mapVOptions.zIndex||0,t.width=parseInt(this.map.canvas.width),t.height=parseInt(this.map.canvas.height),t.style.width=this.map.canvas.style.width,t.style.height=this.map.canvas.style.height;var n=this.devicePixelRatio;return this.mapVOptions.context=="2d"&&t.getContext(this.mapVOptions.context).scale(n,n),t}_reset(){this.resizeCanvas(),this.fixPosition(),this.onResize(),this.render()}draw(){this._reset()}show(){this._visiable()}hide(){this._unvisiable()}destroy(){this.remove()}remove(){this.mapvBaseLayer!=null&&(this.removeAllData(),this.mapvBaseLayer.clear(this.mapvBaseLayer.getContext()),this.mapvBaseLayer=void 0,this.canvas.parentElement.removeChild(this.canvas))}update(t){t!=null&&this.updateData(t.data,t.options)}resizeCanvas(){if(this.canvas!=null&&this.canvas!=null){var t=this.canvas;t.style.position="absolute",t.style.top="0px",t.style.left="0px",t.width=parseInt(this.map.canvas.width),t.height=parseInt(this.map.canvas.height),t.style.width=this.map.canvas.style.width,t.style.height=this.map.canvas.style.height}}fixPosition(){}onResize(){}render(){this.mapvBaseLayer!=null&&this.mapvBaseLayer._canvasUpdate()}}ge=function(e,t,n,s){return new i(e,t,n,s)}}const Di=ge,Bi={getDataSet:function(i){const e=[],t=i.features;if(t)for(let n=0;n<t.length;n++){const s=t[n],a=s.geometry,r=s.properties,o={geometry:a};for(const h in r)o[h]=r[h];e.push(o)}return new O(e)}},Fi={CSVToArray:function(i,e){e=e||",";const t=new RegExp('("'+e+'|\\r?\\n|\\r|^)(?:"([^"]*(?:""[^"]*)*)"|([^""'+e+"\\r\\n]*))","gi"),n=[[]];let s=null;for(;(s=t.exec(i))!==null;){const a=s[1];a.length&&a!==e&&n.push([]);let r;s[2]?r=s[2].replace(new RegExp('""',"g"),'"'):r=s[3],n[n.length-1].push(r)}return n},getDataSet:function(i,e){const t=this.CSVToArray(i,e||","),n=[],s=t[0];for(let a=1;a<t.length-1;a++){const r=t[a],o={};for(let h=0;h<r.length;h++){let l=r[h];s[h]==="geometry"&&(l=JSON.parse(l)),o[s[h]]=l}n.push(o)}return new O(n)}};M.AMapLayer=Ei,M.DataSet=O,M.Map=ii,M.MaptalksLayer=Li,M.OpenlayersLayer=Pi,M.baiduMapAnimationLayer=bi,M.baiduMapCanvasLayer=Y,M.baiduMapLayer=xi,M.canvasClear=G,M.canvasDrawGrid=Wt,M.canvasDrawHeatmap=Zt,M.canvasDrawHoneycomb=Nt,M.canvasDrawSimple=Ct,M.canvasResolutionScale=we,M.cesiumMapLayer=Di,M.csv=Fi,M.geojson=Bi,M.googleMapCanvasLayer=B,M.googleMapLayer=Ci,M.leafletMapLayer=Ti,M.utilCityCenter=Ft,M.utilCurve=ti,M.utilDataRangeCategory=Kt,M.utilDataRangeChoropleth=Qt,M.utilDataRangeIntensity=tt,M.utilForceEdgeBundling=ei,M.version=st,M.webglDrawLine=$t,M.webglDrawPoint=jt,M.webglDrawPolygon=Xt,M.webglDrawSimple=Jt,Object.defineProperty(M,Symbol.toStringTag,{value:"Module"})}));
//# sourceMappingURL=mapv.js.map
