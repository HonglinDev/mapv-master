name: Sync from Gitee to GitHub

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 */6 * * *'  # 每6小时自动同步一次

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取所有历史记录
          submodules: 'recursive'

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Add Gitee remote
        run: |
          git remote add gitee https://gitee.com/HonglinDev/mapv-master.git

      - name: Fetch all from Gitee
        run: |
          git fetch --all --tags --prune
          git fetch gitee --all --tags --prune

      - name: Sync branches to GitHub
        run: |
          # 获取所有本地分支
          branches=$(git branch -r | grep gitee/ | grep -v HEAD | sed 's/gitee\///')
          
          for branch in $branches; do
            echo "Syncing branch: $branch"
            # 检查本地是否存在该分支
            if git branch | grep -q "^\s*$branch$"; then
              git checkout $branch
              git merge --ff-only gitee/$branch || git reset --hard gitee/$branch
            else
              git checkout -b $branch gitee/$branch
            fi
            # 推送到GitHub
            git push origin $branch --force
          done

      - name: Sync tags to GitHub
        run: |
          # 推送所有标签
          git push origin --tags --force

      - name: Sync main/master branch
        run: |
          # 确保主分支是最新的
          git checkout master || git checkout main
          git merge --ff-only gitee/master || git merge --ff-only gitee/main || git reset --hard gitee/master || git reset --hard gitee/main
          git push origin HEAD:master --force || git push origin HEAD:main --force

      - name: Log sync status
        run: |
          echo "Sync completed at $(date)"
          echo "Gitee branches: $(git branch -r | grep gitee/ | wc -l)"
          echo "GitHub branches: $(git branch -r | grep origin/ | wc -l)"
          echo "Tags: $(git tag | wc -l)"
